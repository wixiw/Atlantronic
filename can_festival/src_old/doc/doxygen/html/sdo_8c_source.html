<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>CanFestival: src/sdo.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>src/sdo.c</h1>  </div>
</div>
<div class="contents">
<a href="sdo_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">This file is part of CanFestival, a library implementing CanOpen Stack.</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">Copyright (C): Edouard TISSERANT and Francis DUPIN</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">See COPYING file for copyrights details.</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">This library is free software; you can redistribute it and/or</span>
<a name="l00009"></a>00009 <span class="comment">modify it under the terms of the GNU Lesser General Public</span>
<a name="l00010"></a>00010 <span class="comment">License as published by the Free Software Foundation; either</span>
<a name="l00011"></a>00011 <span class="comment">version 2.1 of the License, or (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment">This library is distributed in the hope that it will be useful,</span>
<a name="l00014"></a>00014 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00016"></a>00016 <span class="comment">Lesser General Public License for more details.</span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment">You should have received a copy of the GNU Lesser General Public</span>
<a name="l00019"></a>00019 <span class="comment">License along with this library; if not, write to the Free Software</span>
<a name="l00020"></a>00020 <span class="comment">Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<a name="l00021"></a>00021 <span class="comment">*/</span>
<a name="l00032"></a>00032 <span class="comment">/* #define DEBUG_WAR_CONSOLE_ON */</span>
<a name="l00033"></a>00033 <span class="comment">/* #define DEBUG_ERR_CONSOLE_ON */</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;canfestival.h&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;sysdep.h&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">/* Uncomment if your compiler does not support inline functions */</span>
<a name="l00039"></a>00039 <span class="preprocessor">#define NO_INLINE</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="preprocessor">#ifdef NO_INLINE</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">  #define INLINE</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">  #define INLINE inline</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="comment">/*Internals prototypes*/</span>
<a name="l00048"></a>00048 
<a name="l00064"></a>00064 INLINE UNS8 <a class="code" href="sdo_8c.html#a1a6276b79084a0905c07acc5fcfc5dc9">_writeNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS16 index,
<a name="l00065"></a>00065                        UNS8 subIndex, UNS32 count, UNS8 dataType, <span class="keywordtype">void</span> *data, SDOCallback_t Callback, UNS8 endianize);
<a name="l00066"></a>00066 
<a name="l00079"></a>00079 INLINE UNS8 <a class="code" href="sdo_8c.html#a4bb4b3cd35af7e7580cffde23e9d3270">_readNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS16 index, UNS8 subIndex,
<a name="l00080"></a>00080         UNS8 dataType, SDOCallback_t Callback);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="comment">/***************************************************************************/</span>
<a name="l00084"></a>00084 <span class="comment">/* SDO (un)packing macros */</span>
<a name="l00085"></a>00085 
<a name="l00088"></a><a class="code" href="sdo_8c.html#ace5a1634ff4089db3b228cdd5010c321">00088</a> <span class="preprocessor">#define getSDOcs(byte) (byte &gt;&gt; 5)</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span>
<a name="l00092"></a><a class="code" href="sdo_8c.html#adfd3877d80f6b903b491a115e587bd14">00092</a> <span class="preprocessor">#define getSDOn2(byte) ((byte &gt;&gt; 2) &amp; 3)</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span>
<a name="l00096"></a><a class="code" href="sdo_8c.html#ae5677ca12bfb71b06cbd6e99e9be0955">00096</a> <span class="preprocessor">#define getSDOn3(byte) ((byte &gt;&gt; 1) &amp; 7)</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>
<a name="l00100"></a><a class="code" href="sdo_8c.html#acf60675f20de8746e279dce3a5c8e3c6">00100</a> <span class="preprocessor">#define getSDOe(byte) ((byte &gt;&gt; 1) &amp; 1)</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>
<a name="l00104"></a><a class="code" href="sdo_8c.html#af7f9e9bc3d59c9772d4c767b199dcf89">00104</a> <span class="preprocessor">#define getSDOs(byte) (byte &amp; 1)</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span>
<a name="l00108"></a><a class="code" href="sdo_8c.html#ae5a2dafe8497bff1fd88f881ea74414d">00108</a> <span class="preprocessor">#define getSDOc(byte) (byte &amp; 1)</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>
<a name="l00112"></a><a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">00112</a> <span class="preprocessor">#define getSDOt(byte) ((byte &gt;&gt; 4) &amp; 1)</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>
<a name="l00116"></a><a class="code" href="sdo_8c.html#ad9b34e26bf67f1251f3bb364756e17f1">00116</a> <span class="preprocessor">#define getSDOindex(byte1, byte2) (((UNS16)byte2 &lt;&lt; 8) | ((UNS16)byte1))</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>
<a name="l00120"></a><a class="code" href="sdo_8c.html#a52a96f6fa6083f6b291133135b7155a8">00120</a> <span class="preprocessor">#define getSDOsubIndex(byte3) (byte3)</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span>
<a name="l00128"></a><a class="code" href="sdo_8c.html#a9309025e29b59e09026abcd3b45a5b61">00128</a> <span class="keywordtype">void</span> <a class="code" href="sdo_8c.html#a9309025e29b59e09026abcd3b45a5b61" title="Reset of a SDO exchange on timeout. Send a SDO abort.">SDOTimeoutAlarm</a>(<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS32 <span class="keywordtype">id</span>)
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130     MSG_ERR(0x1A01, <span class="stringliteral">&quot;SDO timeout. SDO response not received.&quot;</span>, 0);
<a name="l00131"></a>00131     MSG_WAR(0x2A02, <span class="stringliteral">&quot;server node : &quot;</span>, d-&gt;transfers[<span class="keywordtype">id</span>].nodeId);
<a name="l00132"></a>00132     MSG_WAR(0x2A02, <span class="stringliteral">&quot;      index : &quot;</span>, d-&gt;transfers[<span class="keywordtype">id</span>].index);
<a name="l00133"></a>00133     MSG_WAR(0x2A02, <span class="stringliteral">&quot;   subIndex : &quot;</span>, d-&gt;transfers[<span class="keywordtype">id</span>].subIndex);
<a name="l00134"></a>00134     <span class="comment">/* Reset timer handler */</span>
<a name="l00135"></a>00135     d-&gt;transfers[id].timer = TIMER_NONE;
<a name="l00136"></a>00136     <span class="comment">/*Set aborted state*/</span>
<a name="l00137"></a>00137     d-&gt;transfers[id].state = SDO_ABORTED_INTERNAL;
<a name="l00138"></a>00138     <span class="comment">/* Sending a SDO abort */</span>
<a name="l00139"></a>00139     <a class="code" href="sdo_8c.html#abb85c47a1a6c3774f87b685b7d493e1d" title="Transmit a SDO error to the client. The reasons may be : Read/Write to a undefined object Read/Write ...">sendSDOabort</a>(d, d-&gt;transfers[<span class="keywordtype">id</span>].whoami, d-&gt;transfers[<span class="keywordtype">id</span>].nodeId,
<a name="l00140"></a>00140                  d-&gt;transfers[<span class="keywordtype">id</span>].index, d-&gt;transfers[<span class="keywordtype">id</span>].subIndex, SDOABT_TIMED_OUT);
<a name="l00141"></a>00141     d-&gt;transfers[id].abortCode = SDOABT_TIMED_OUT;
<a name="l00142"></a>00142     <span class="comment">/* Call the user function to inform of the problem.*/</span>
<a name="l00143"></a>00143     <span class="keywordflow">if</span>(d-&gt;transfers[<span class="keywordtype">id</span>].Callback)
<a name="l00144"></a>00144         <span class="comment">/*If ther is a callback, it is responsible to close SDO transfer (client)*/</span>
<a name="l00145"></a>00145         (*d-&gt;transfers[id].Callback)(d,d-&gt;transfers[<span class="keywordtype">id</span>].nodeId);
<a name="l00146"></a>00146     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(d-&gt;transfers[<span class="keywordtype">id</span>].whoami == SDO_SERVER)
<a name="l00147"></a>00147         <span class="comment">/*Else, if server, reset the line*/</span>
<a name="l00148"></a>00148         <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>(d, (UNS8)<span class="keywordtype">id</span>);
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="preprocessor">#define StopSDO_TIMER(id) \</span>
<a name="l00152"></a>00152 <span class="preprocessor">MSG_WAR(0x3A05, &quot;StopSDO_TIMER for line : &quot;, line);\</span>
<a name="l00153"></a>00153 <span class="preprocessor">d-&gt;transfers[id].timer = DelAlarm(d-&gt;transfers[id].timer);</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>
<a name="l00155"></a>00155 <span class="preprocessor">#define StartSDO_TIMER(id) \</span>
<a name="l00156"></a>00156 <span class="preprocessor">MSG_WAR(0x3A06, &quot;StartSDO_TIMER for line : &quot;, line);\</span>
<a name="l00157"></a>00157 <span class="preprocessor">d-&gt;transfers[id].timer = SetAlarm(d,id,&amp;SDOTimeoutAlarm,MS_TO_TIMEVAL(SDO_TIMEOUT_MS),0);</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>
<a name="l00159"></a>00159 <span class="preprocessor">#define RestartSDO_TIMER(id) \</span>
<a name="l00160"></a>00160 <span class="preprocessor">MSG_WAR(0x3A07, &quot;restartSDO_TIMER for line : &quot;, line);\</span>
<a name="l00161"></a>00161 <span class="preprocessor">if(d-&gt;transfers[id].timer != TIMER_NONE) { StopSDO_TIMER(id) StartSDO_TIMER(id) }</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span>
<a name="l00168"></a><a class="code" href="sdo_8c.html#a1f4f07eccc4890a11ccf4f632da7740b">00168</a> <span class="keywordtype">void</span> <a class="code" href="sdo_8c.html#a1f4f07eccc4890a11ccf4f632da7740b" title="Reset all SDO buffers.">resetSDO</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d)
<a name="l00169"></a>00169 {
<a name="l00170"></a>00170   UNS8 j;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172   <span class="comment">/* transfer structure initialization */</span>
<a name="l00173"></a>00173     <span class="keywordflow">for</span> (j = 0 ; j &lt; SDO_MAX_SIMULTANEOUS_TRANSFERTS ; j++)
<a name="l00174"></a>00174       <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>(d, j);
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00185"></a><a class="code" href="sdo_8c.html#a2eb5309dca3a7363da5e5e7230b85d58">00185</a> UNS32 <a class="code" href="sdo_8c.html#a2eb5309dca3a7363da5e5e7230b85d58" title="Copy the data received from the SDO line transfert to the object dictionary.">SDOlineToObjdict</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 line)
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187   UNS32 size;
<a name="l00188"></a>00188   UNS32 errorCode;
<a name="l00189"></a>00189   MSG_WAR(0x3A08, <span class="stringliteral">&quot;Enter in SDOlineToObjdict &quot;</span>, line);
<a name="l00190"></a>00190   <span class="comment">/* if SDO initiated with e=0 and s=0 count is null, offset carry effective size*/</span>
<a name="l00191"></a>00191   <span class="keywordflow">if</span>( d-&gt;transfers[line].count == 0)
<a name="l00192"></a>00192         d-&gt;transfers[line].count = d-&gt;transfers[line].offset;
<a name="l00193"></a>00193   size = d-&gt;transfers[line].count;
<a name="l00194"></a>00194   errorCode = <a class="code" href="group__od.html#ga3417b8ecd54a73528afc30b77f7d464c" title="setODentry converts SourceData from network byte order to machine native format, and writes that to O...">setODentry</a>(d, d-&gt;transfers[line].index, d-&gt;transfers[line].subIndex,
<a name="l00195"></a>00195                          (<span class="keywordtype">void</span> *) d-&gt;transfers[line].data, &amp;size, 1);
<a name="l00196"></a>00196   <span class="keywordflow">if</span> (errorCode != OD_SUCCESSFUL)
<a name="l00197"></a>00197     <span class="keywordflow">return</span> errorCode;
<a name="l00198"></a>00198   MSG_WAR(0x3A08, <span class="stringliteral">&quot;exit of SDOlineToObjdict &quot;</span>, line);
<a name="l00199"></a>00199   <span class="keywordflow">return</span> 0;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00211"></a><a class="code" href="sdo_8c.html#a29427a80fd1aeabff30bf0602fbc220f">00211</a> UNS32 <a class="code" href="sdo_8c.html#a29427a80fd1aeabff30bf0602fbc220f" title="Copy the data from the object dictionary to the SDO line for a network transfert.">objdictToSDOline</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 line)
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213   UNS32  size = 0;
<a name="l00214"></a>00214   UNS8  dataType;
<a name="l00215"></a>00215   UNS32 errorCode;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217   MSG_WAR(0x3A05, <span class="stringliteral">&quot;objdict-&gt;line index : &quot;</span>, d-&gt;transfers[line].index);
<a name="l00218"></a>00218   MSG_WAR(0x3A06, <span class="stringliteral">&quot;  subIndex : &quot;</span>, d-&gt;transfers[line].subIndex);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220   errorCode = <a class="code" href="group__od.html#ga811a637353eaa89cfae43957f7b3b68a" title="getODentry() to read from object and endianize">getODentry</a>(d,     d-&gt;transfers[line].index,
<a name="l00221"></a>00221                                 d-&gt;transfers[line].subIndex,
<a name="l00222"></a>00222                                 (<span class="keywordtype">void</span> *)d-&gt;transfers[line].data,
<a name="l00223"></a>00223                                 &amp;size, &amp;dataType, 1);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225   <span class="keywordflow">if</span> (errorCode != OD_SUCCESSFUL)
<a name="l00226"></a>00226     <span class="keywordflow">return</span> errorCode;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   d-&gt;transfers[line].count = size;
<a name="l00229"></a>00229   d-&gt;transfers[line].offset = 0;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231   <span class="keywordflow">return</span> 0;
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00244"></a><a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e">00244</a> UNS8 <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e" title="Copy data from an existant line in the argument &amp;quot;* data&amp;quot;.">lineToSDO</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 line, UNS32 nbBytes, UNS8* data) {
<a name="l00245"></a>00245   UNS8 i;
<a name="l00246"></a>00246   UNS32 offset;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248   <span class="keywordflow">if</span> ((d-&gt;transfers[line].offset + nbBytes) &gt; SDO_MAX_LENGTH_TRANSFERT) {
<a name="l00249"></a>00249     MSG_ERR(0x1A10,<span class="stringliteral">&quot;SDO Size of data too large. Exceed SDO_MAX_LENGTH_TRANSFERT&quot;</span>, nbBytes);
<a name="l00250"></a>00250     <span class="keywordflow">return</span> 0xFF;
<a name="l00251"></a>00251   }
<a name="l00252"></a>00252     <span class="keywordflow">if</span> ((d-&gt;transfers[line].offset + nbBytes) &gt; d-&gt;transfers[line].count) {
<a name="l00253"></a>00253     MSG_ERR(0x1A11,<span class="stringliteral">&quot;SDO Size of data too large. Exceed count&quot;</span>, nbBytes);
<a name="l00254"></a>00254     <span class="keywordflow">return</span> 0xFF;
<a name="l00255"></a>00255   }
<a name="l00256"></a>00256   offset = d-&gt;transfers[line].offset;
<a name="l00257"></a>00257   <span class="keywordflow">for</span> (i = 0 ; i &lt; nbBytes ; i++)
<a name="l00258"></a>00258     * (data + i) = d-&gt;transfers[line].data[offset + i];
<a name="l00259"></a>00259   d-&gt;transfers[line].offset = d-&gt;transfers[line].offset + nbBytes;
<a name="l00260"></a>00260   <span class="keywordflow">return</span> 0;
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00273"></a><a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55">00273</a> UNS8 <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55" title="Add data to an existant line.">SDOtoLine</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 line, UNS32 nbBytes, UNS8* data)
<a name="l00274"></a>00274 {
<a name="l00275"></a>00275   UNS8 i;
<a name="l00276"></a>00276   UNS32 offset;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278   <span class="keywordflow">if</span> ((d-&gt;transfers[line].offset + nbBytes) &gt; SDO_MAX_LENGTH_TRANSFERT) {
<a name="l00279"></a>00279     MSG_ERR(0x1A15,<span class="stringliteral">&quot;SDO Size of data too large. Exceed SDO_MAX_LENGTH_TRANSFERT&quot;</span>, nbBytes);
<a name="l00280"></a>00280     <span class="keywordflow">return</span> 0xFF;
<a name="l00281"></a>00281   }
<a name="l00282"></a>00282   offset = d-&gt;transfers[line].offset;
<a name="l00283"></a>00283   <span class="keywordflow">for</span> (i = 0 ; i &lt; nbBytes ; i++)
<a name="l00284"></a>00284     d-&gt;transfers[line].data[offset + i] = * (data + i);
<a name="l00285"></a>00285   d-&gt;transfers[line].offset = d-&gt;transfers[line].offset + nbBytes;
<a name="l00286"></a>00286   <span class="keywordflow">return</span> 0;
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00301"></a><a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9">00301</a> UNS8 <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS8 whoami, UNS16 index,
<a name="l00302"></a>00302                 UNS8 subIndex, UNS32 abortCode)
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304   UNS8 err;
<a name="l00305"></a>00305   UNS8 line;
<a name="l00306"></a>00306   err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line );
<a name="l00307"></a>00307   <span class="keywordflow">if</span> (!err) <span class="comment">/* If a line on use have been found.*/</span>
<a name="l00308"></a>00308     MSG_WAR(0x3A20, <span class="stringliteral">&quot;FailedSDO : line found : &quot;</span>, line);
<a name="l00309"></a>00309   <span class="keywordflow">if</span> ((! err) &amp;&amp; (whoami == SDO_SERVER)) {
<a name="l00310"></a>00310     <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>( d, line );
<a name="l00311"></a>00311     MSG_WAR(0x3A21, <span class="stringliteral">&quot;FailedSDO : line released : &quot;</span>, line);
<a name="l00312"></a>00312   }
<a name="l00313"></a>00313   <span class="keywordflow">if</span> ((! err) &amp;&amp; (whoami == SDO_CLIENT)) {
<a name="l00314"></a>00314     StopSDO_TIMER(line);
<a name="l00315"></a>00315     d-&gt;transfers[line].state = SDO_ABORTED_INTERNAL;
<a name="l00316"></a>00316   }
<a name="l00317"></a>00317   MSG_WAR(0x3A22, <span class="stringliteral">&quot;Sending SDO abort &quot;</span>, 0);
<a name="l00318"></a>00318   err = <a class="code" href="sdo_8c.html#abb85c47a1a6c3774f87b685b7d493e1d" title="Transmit a SDO error to the client. The reasons may be : Read/Write to a undefined object Read/Write ...">sendSDOabort</a>(d, whoami, nodeId, index, subIndex, abortCode);
<a name="l00319"></a>00319   <span class="keywordflow">if</span> (err) {
<a name="l00320"></a>00320     MSG_WAR(0x3A23, <span class="stringliteral">&quot;Unable to send the SDO abort&quot;</span>, 0);
<a name="l00321"></a>00321     <span class="keywordflow">return</span> 0xFF;
<a name="l00322"></a>00322   }
<a name="l00323"></a>00323   <span class="keywordflow">return</span> 0;
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00332"></a><a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481">00332</a> <span class="keywordtype">void</span> <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a> ( <a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 line )
<a name="l00333"></a>00333 {
<a name="l00334"></a>00334   UNS32 i;
<a name="l00335"></a>00335   MSG_WAR(0x3A25, <span class="stringliteral">&quot;reset SDO line nb : &quot;</span>, line);
<a name="l00336"></a>00336   <a class="code" href="sdo_8c.html#ab9c873a15f55b29112b5527a6cc6898d" title="Initialize some fields of the structure.">initSDOline</a>(d, line, 0, 0, 0, SDO_RESET);
<a name="l00337"></a>00337   <span class="keywordflow">for</span> (i = 0 ; i &lt; SDO_MAX_LENGTH_TRANSFERT ; i++)
<a name="l00338"></a>00338     d-&gt;transfers[line].data[i] = 0;
<a name="l00339"></a>00339   d-&gt;transfers[line].whoami = 0;
<a name="l00340"></a>00340   d-&gt;transfers[line].abortCode = 0;
<a name="l00341"></a>00341 }
<a name="l00342"></a>00342 
<a name="l00355"></a><a class="code" href="sdo_8c.html#ab9c873a15f55b29112b5527a6cc6898d">00355</a> UNS8 <a class="code" href="sdo_8c.html#ab9c873a15f55b29112b5527a6cc6898d" title="Initialize some fields of the structure.">initSDOline</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 line, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 state)
<a name="l00356"></a>00356 {
<a name="l00357"></a>00357   MSG_WAR(0x3A25, <span class="stringliteral">&quot;init SDO line nb : &quot;</span>, line);
<a name="l00358"></a>00358   <span class="keywordflow">if</span> (state == SDO_DOWNLOAD_IN_PROGRESS || state == SDO_UPLOAD_IN_PROGRESS){
<a name="l00359"></a>00359         StartSDO_TIMER(line)
<a name="l00360"></a>00360   }<span class="keywordflow">else</span>{
<a name="l00361"></a>00361         StopSDO_TIMER(line)
<a name="l00362"></a>00362   }
<a name="l00363"></a>00363   d-&gt;transfers[line].nodeId = nodeId;
<a name="l00364"></a>00364   d-&gt;transfers[line].index = index;
<a name="l00365"></a>00365   d-&gt;transfers[line].subIndex = subIndex;
<a name="l00366"></a>00366   d-&gt;transfers[line].state = state;
<a name="l00367"></a>00367   d-&gt;transfers[line].toggle = 0;
<a name="l00368"></a>00368   d-&gt;transfers[line].count = 0;
<a name="l00369"></a>00369   d-&gt;transfers[line].offset = 0;
<a name="l00370"></a>00370   d-&gt;transfers[line].dataType = 0;
<a name="l00371"></a>00371   d-&gt;transfers[line].Callback = NULL;
<a name="l00372"></a>00372   <span class="keywordflow">return</span> 0;
<a name="l00373"></a>00373 }
<a name="l00374"></a>00374 
<a name="l00384"></a><a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252">00384</a> UNS8 <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252" title="Search for an unused line in the transfers array to store a new SDO. ie a line which value of the fie...">getSDOfreeLine</a> ( <a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 whoami, UNS8 *line )
<a name="l00385"></a>00385 {
<a name="l00386"></a>00386 
<a name="l00387"></a>00387   UNS8 i;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389   <span class="keywordflow">for</span> (i = 0 ; i &lt; SDO_MAX_SIMULTANEOUS_TRANSFERTS ; i++){
<a name="l00390"></a>00390     <span class="keywordflow">if</span> ( d-&gt;transfers[i].state == SDO_RESET ) {
<a name="l00391"></a>00391       *line = i;
<a name="l00392"></a>00392       d-&gt;transfers[i].whoami = whoami;
<a name="l00393"></a>00393       <span class="keywordflow">return</span> 0;
<a name="l00394"></a>00394     } <span class="comment">/* end if */</span>
<a name="l00395"></a>00395   } <span class="comment">/* end for */</span>
<a name="l00396"></a>00396   MSG_ERR(0x1A25, <span class="stringliteral">&quot;Too many SDO in progress. Aborted.&quot;</span>, i);
<a name="l00397"></a>00397   <span class="keywordflow">return</span> 0xFF;
<a name="l00398"></a>00398 }
<a name="l00399"></a>00399 
<a name="l00410"></a><a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f">00410</a> UNS8 <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS8 whoami, UNS8 *line)
<a name="l00411"></a>00411 {
<a name="l00412"></a>00412 
<a name="l00413"></a>00413   UNS8 i;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415   <span class="keywordflow">for</span> (i = 0 ; i &lt; SDO_MAX_SIMULTANEOUS_TRANSFERTS ; i++){
<a name="l00416"></a>00416     <span class="keywordflow">if</span> ( (d-&gt;transfers[i].state != SDO_RESET) &amp;&amp;
<a name="l00417"></a>00417      (d-&gt;transfers[i].state != SDO_ABORTED_INTERNAL) &amp;&amp;
<a name="l00418"></a>00418          (d-&gt;transfers[i].nodeId == nodeId) &amp;&amp;
<a name="l00419"></a>00419          (d-&gt;transfers[i].whoami == whoami) ) {
<a name="l00420"></a>00420       *line = i;
<a name="l00421"></a>00421       <span class="keywordflow">return</span> 0;
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423   }
<a name="l00424"></a>00424   <span class="keywordflow">return</span> 0xFF;
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00436"></a><a class="code" href="sdo_8c.html#a555a772d3a88a29c495f33513f8b2d58">00436</a> UNS8 <a class="code" href="sdo_8c.html#a555a772d3a88a29c495f33513f8b2d58" title="Close a transmission.">closeSDOtransfer</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS8 whoami)
<a name="l00437"></a>00437 {
<a name="l00438"></a>00438   UNS8 err;
<a name="l00439"></a>00439   UNS8 line;
<a name="l00440"></a>00440   err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>(d, nodeId, whoami, &amp;line);
<a name="l00441"></a>00441   <span class="keywordflow">if</span> (err) {
<a name="l00442"></a>00442     MSG_WAR(0x2A30, <span class="stringliteral">&quot;No SDO communication to close for node : &quot;</span>, nodeId);
<a name="l00443"></a>00443     <span class="keywordflow">return</span> 0xFF;
<a name="l00444"></a>00444   }
<a name="l00445"></a>00445   <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>(d, line);
<a name="l00446"></a>00446   <span class="keywordflow">return</span> 0;
<a name="l00447"></a>00447 }
<a name="l00448"></a>00448 
<a name="l00458"></a><a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb">00458</a> UNS8 <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb" title="Bytes in the line structure which must be transmited (or received).">getSDOlineRestBytes</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 line, UNS32 * nbBytes)
<a name="l00459"></a>00459 {
<a name="l00460"></a>00460   <span class="comment">/* SDO initiated with e=0 and s=0 have count set to null */</span>
<a name="l00461"></a>00461   <span class="keywordflow">if</span> (d-&gt;transfers[line].count == 0)
<a name="l00462"></a>00462     * nbBytes = 0;
<a name="l00463"></a>00463   <span class="keywordflow">else</span>
<a name="l00464"></a>00464     * nbBytes = d-&gt;transfers[line].count - d-&gt;transfers[line].offset;
<a name="l00465"></a>00465   <span class="keywordflow">return</span> 0;
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00477"></a><a class="code" href="sdo_8c.html#a7ca56a650c5daaa24c89370f3b3d7bb0">00477</a> UNS8 <a class="code" href="sdo_8c.html#a7ca56a650c5daaa24c89370f3b3d7bb0" title="Store in the line structure the nb of bytes which must be transmited (or received).">setSDOlineRestBytes</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 line, UNS32 nbBytes)
<a name="l00478"></a>00478 {
<a name="l00479"></a>00479   <span class="keywordflow">if</span> (nbBytes &gt; SDO_MAX_LENGTH_TRANSFERT) {
<a name="l00480"></a>00480     MSG_ERR(0x1A35,<span class="stringliteral">&quot;SDO Size of data too large. Exceed SDO_MAX_LENGTH_TRANSFERT&quot;</span>, nbBytes);
<a name="l00481"></a>00481     <span class="keywordflow">return</span> 0xFF;
<a name="l00482"></a>00482   }
<a name="l00483"></a>00483   d-&gt;transfers[line].count = nbBytes;
<a name="l00484"></a>00484   <span class="keywordflow">return</span> 0;
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00496"></a><a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d">00496</a> UNS8 <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 whoami, s_SDO sdo)
<a name="l00497"></a>00497 {
<a name="l00498"></a>00498   UNS16 offset;
<a name="l00499"></a>00499   UNS16 lastIndex;
<a name="l00500"></a>00500   UNS8 found = 0;
<a name="l00501"></a>00501   <a class="code" href="structMessage.html" title="The CAN message structure.">Message</a> m;
<a name="l00502"></a>00502   UNS8 i;
<a name="l00503"></a>00503   UNS32 * pwCobId = NULL;
<a name="l00504"></a>00504   UNS8 * pwNodeId = NULL;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506   MSG_WAR(0x3A38, <span class="stringliteral">&quot;sendSDO&quot;</span>,0);
<a name="l00507"></a>00507   <span class="keywordflow">if</span>( !((d-&gt;nodeState == Operational) ||  (d-&gt;nodeState == Pre_operational ))) {
<a name="l00508"></a>00508     MSG_WAR(0x2A39, <span class="stringliteral">&quot;unable to send the SDO (not in op or pre-op mode&quot;</span>, d-&gt;nodeState);
<a name="l00509"></a>00509     <span class="keywordflow">return</span> 0xFF;
<a name="l00510"></a>00510   }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512   <span class="comment">/*get the server-&gt;client cobid*/</span>
<a name="l00513"></a>00513   <span class="keywordflow">if</span> ( whoami == SDO_SERVER )   {<span class="comment">/*case server. only one SDO server*/</span>
<a name="l00514"></a>00514     offset = d-&gt;firstIndex-&gt;SDO_SVR;
<a name="l00515"></a>00515     <span class="keywordflow">if</span> (offset == 0) {
<a name="l00516"></a>00516       MSG_ERR(0x1A42, <span class="stringliteral">&quot;SendSDO : No SDO server found&quot;</span>, 0);
<a name="l00517"></a>00517       <span class="keywordflow">return</span> 0xFF;
<a name="l00518"></a>00518     }
<a name="l00519"></a>00519     pwCobId = (UNS32*) d-&gt;objdict[offset].pSubindex[2].pObject;
<a name="l00520"></a>00520     MSG_WAR(0x3A41, <span class="stringliteral">&quot;I am server. cobId : &quot;</span>, *pwCobId);
<a name="l00521"></a>00521   }
<a name="l00522"></a>00522   <span class="keywordflow">else</span> {                        <span class="comment">/*case client*/</span>
<a name="l00523"></a>00523     <span class="comment">/* Get the client-&gt;server cobid.*/</span>
<a name="l00524"></a>00524     UNS16 sdoNum = 0;
<a name="l00525"></a>00525     offset = d-&gt;firstIndex-&gt;SDO_CLT;
<a name="l00526"></a>00526     lastIndex = d-&gt;lastIndex-&gt;SDO_CLT;
<a name="l00527"></a>00527     <span class="keywordflow">if</span> (offset == 0) {
<a name="l00528"></a>00528       MSG_ERR(0x1A42, <span class="stringliteral">&quot;SendSDO : No SDO client index found&quot;</span>, 0);
<a name="l00529"></a>00529       <span class="keywordflow">return</span> 0xFF;
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531     <span class="comment">/* find index for communication server node */</span>
<a name="l00532"></a>00532     <span class="keywordflow">while</span> (offset &lt;= lastIndex){
<a name="l00533"></a>00533       MSG_WAR(0x3A43,<span class="stringliteral">&quot;Reading index : &quot;</span>, 0x1280 + sdoNum);
<a name="l00534"></a>00534       <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 3) {
<a name="l00535"></a>00535         MSG_ERR(0x1A28, <span class="stringliteral">&quot;Subindex 3  not found at index &quot;</span>, 0x1280 + sdoNum);
<a name="l00536"></a>00536         <span class="keywordflow">return</span> 0xFF;
<a name="l00537"></a>00537       }
<a name="l00538"></a>00538       pwNodeId = (UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject;
<a name="l00539"></a>00539       MSG_WAR(0x3A44, <span class="stringliteral">&quot;Found nodeId server = &quot;</span>, *pwNodeId);
<a name="l00540"></a>00540       <span class="keywordflow">if</span>(*pwNodeId == sdo.nodeId) {
<a name="l00541"></a>00541         found = 1;
<a name="l00542"></a>00542         <span class="keywordflow">break</span>;
<a name="l00543"></a>00543       }
<a name="l00544"></a>00544       offset ++;
<a name="l00545"></a>00545       sdoNum ++;
<a name="l00546"></a>00546     }
<a name="l00547"></a>00547     <span class="keywordflow">if</span> (! found){
<a name="l00548"></a>00548       MSG_WAR (0x2A45, <span class="stringliteral">&quot;No SDO client corresponds to the mesage to send to node &quot;</span>, sdo.nodeId);
<a name="l00549"></a>00549       <span class="keywordflow">return</span> 0xFF;
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551     <span class="comment">/* read the client-&gt;server cobid */</span>
<a name="l00552"></a>00552     pwCobId = (UNS32*) d-&gt;objdict[offset].pSubindex[1].pObject;
<a name="l00553"></a>00553   }
<a name="l00554"></a>00554   <span class="comment">/* message copy for sending */</span>
<a name="l00555"></a>00555   m.<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a> = (UNS16)UNS16_LE(*pwCobId);
<a name="l00556"></a>00556   m.<a class="code" href="structMessage.html#a41c5a4e7eaeb2c2ae1af2b2c83129615">rtr</a> = NOT_A_REQUEST;
<a name="l00557"></a>00557   <span class="comment">/* the length of SDO must be 8 */</span>
<a name="l00558"></a>00558   m.<a class="code" href="structMessage.html#ad1dd9a88dda088ff4c7073d49613613d">len</a> = 8;
<a name="l00559"></a>00559   <span class="keywordflow">for</span> (i = 0 ; i &lt; 8 ; i++) {
<a name="l00560"></a>00560     m.<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[i] =  sdo.body.data[i];
<a name="l00561"></a>00561   }
<a name="l00562"></a>00562   <span class="keywordflow">return</span> canSend(d-&gt;canHandle,&amp;m);
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00576"></a><a class="code" href="sdo_8c.html#abb85c47a1a6c3774f87b685b7d493e1d">00576</a> UNS8 <a class="code" href="sdo_8c.html#abb85c47a1a6c3774f87b685b7d493e1d" title="Transmit a SDO error to the client. The reasons may be : Read/Write to a undefined object Read/Write ...">sendSDOabort</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 whoami, UNS8 nodeID, UNS16 index, UNS8 subIndex, UNS32 abortCode)
<a name="l00577"></a>00577 {
<a name="l00578"></a>00578   s_SDO sdo;
<a name="l00579"></a>00579   UNS8 ret;
<a name="l00580"></a>00580   
<a name="l00581"></a>00581   MSG_WAR(0x2A50,<span class="stringliteral">&quot;Sending SDO abort &quot;</span>, abortCode);
<a name="l00582"></a>00582   <span class="keywordflow">if</span>(whoami == SDO_SERVER)
<a name="l00583"></a>00583   {
<a name="l00584"></a>00584         sdo.nodeId = *d-&gt;bDeviceNodeId;
<a name="l00585"></a>00585   }
<a name="l00586"></a>00586   <span class="keywordflow">else</span>
<a name="l00587"></a>00587   {
<a name="l00588"></a>00588     sdo.nodeId = nodeID;
<a name="l00589"></a>00589   }
<a name="l00590"></a>00590   sdo.body.data[0] = 0x80;
<a name="l00591"></a>00591   <span class="comment">/* Index */</span>
<a name="l00592"></a>00592   sdo.body.data[1] = index &amp; 0xFF; <span class="comment">/* LSB */</span>
<a name="l00593"></a>00593   sdo.body.data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span>
<a name="l00594"></a>00594   <span class="comment">/* Subindex */</span>
<a name="l00595"></a>00595   sdo.body.data[3] = subIndex;
<a name="l00596"></a>00596   <span class="comment">/* Data */</span>
<a name="l00597"></a>00597   sdo.body.data[4] = (UNS8)(abortCode &amp; 0xFF);
<a name="l00598"></a>00598   sdo.body.data[5] = (UNS8)((abortCode &gt;&gt; 8) &amp; 0xFF);
<a name="l00599"></a>00599   sdo.body.data[6] = (UNS8)((abortCode &gt;&gt; 16) &amp; 0xFF);
<a name="l00600"></a>00600   sdo.body.data[7] = (UNS8)((abortCode &gt;&gt; 24) &amp; 0xFF);
<a name="l00601"></a>00601   ret = <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l00602"></a>00602 
<a name="l00603"></a>00603   <span class="keywordflow">return</span> ret;
<a name="l00604"></a>00604 }
<a name="l00605"></a>00605 
<a name="l00614"></a><a class="code" href="sdo_8c.html#a2a93a7c780472b1d8666d89aa270f661">00614</a> UNS8 <a class="code" href="sdo_8c.html#a2a93a7c780472b1d8666d89aa270f661" title="Treat a SDO frame reception call the function sendSDO.">proceedSDO</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, <a class="code" href="structMessage.html" title="The CAN message structure.">Message</a> *m)
<a name="l00615"></a>00615 {
<a name="l00616"></a>00616   UNS8 err;
<a name="l00617"></a>00617   UNS8 line;
<a name="l00618"></a>00618   UNS32 nbBytes; <span class="comment">/* received or to be transmited. */</span>
<a name="l00619"></a>00619   UNS8 nodeId = 0;  <span class="comment">/* The node from which the SDO is received */</span>
<a name="l00620"></a>00620   UNS8 *pNodeId = NULL;
<a name="l00621"></a>00621   UNS8 whoami = SDO_UNKNOWN;  <span class="comment">/* SDO_SERVER or SDO_CLIENT.*/</span>
<a name="l00622"></a>00622   UNS32 errorCode; <span class="comment">/* while reading or writing in the local object dictionary.*/</span>
<a name="l00623"></a>00623   s_SDO sdo;    <span class="comment">/* SDO to transmit */</span>
<a name="l00624"></a>00624   UNS16 index;
<a name="l00625"></a>00625   UNS8 subIndex;
<a name="l00626"></a>00626   UNS32 abortCode;
<a name="l00627"></a>00627   UNS32 i;
<a name="l00628"></a>00628   UNS8  j;
<a name="l00629"></a>00629   UNS32 *pCobId = NULL;
<a name="l00630"></a>00630   UNS16 offset;
<a name="l00631"></a>00631   UNS16 lastIndex;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633   MSG_WAR(0x3A60, <span class="stringliteral">&quot;proceedSDO &quot;</span>, 0);
<a name="l00634"></a>00634   whoami = SDO_UNKNOWN;
<a name="l00635"></a>00635   <span class="comment">/* Looking for the cobId in the object dictionary. */</span>
<a name="l00636"></a>00636   <span class="comment">/* Am-I a server ? */</span>
<a name="l00637"></a>00637   offset = d-&gt;firstIndex-&gt;SDO_SVR;
<a name="l00638"></a>00638   lastIndex = d-&gt;lastIndex-&gt;SDO_SVR;
<a name="l00639"></a>00639   j = 0;
<a name="l00640"></a>00640   <span class="keywordflow">if</span>(offset) <span class="keywordflow">while</span> (offset &lt;= lastIndex) {
<a name="l00641"></a>00641      <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 1) {
<a name="l00642"></a>00642           MSG_ERR(0x1A61, <span class="stringliteral">&quot;Subindex 1  not found at index &quot;</span>, 0x1200 + j);
<a name="l00643"></a>00643           <span class="keywordflow">return</span> 0xFF;
<a name="l00644"></a>00644         }
<a name="l00645"></a>00645       pCobId = (UNS32*) d-&gt;objdict[offset].pSubindex[1].pObject;
<a name="l00646"></a>00646       if ( *pCobId == UNS16_LE(m-&gt;<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a>) ) {
<a name="l00647"></a>00647         whoami = SDO_SERVER;
<a name="l00648"></a>00648         MSG_WAR(0x3A62, <span class="stringliteral">&quot;proceedSDO. I am server. index : &quot;</span>, 0x1200 + j);
<a name="l00649"></a>00649         <span class="comment">/* In case of server, the node id of the client may be unknown. So we put the index minus offset */</span>
<a name="l00650"></a>00650         <span class="comment">/* 0x1200 where the cobid received is defined. */</span>
<a name="l00651"></a>00651         nodeId = j;
<a name="l00652"></a>00652         <span class="keywordflow">break</span>;
<a name="l00653"></a>00653       }
<a name="l00654"></a>00654       j++;
<a name="l00655"></a>00655       offset++;
<a name="l00656"></a>00656   } <span class="comment">/* end while */</span>
<a name="l00657"></a>00657   <span class="keywordflow">if</span> (whoami == SDO_UNKNOWN) {
<a name="l00658"></a>00658     <span class="comment">/* Am-I client ? */</span>
<a name="l00659"></a>00659     offset = d-&gt;firstIndex-&gt;SDO_CLT;
<a name="l00660"></a>00660     lastIndex = d-&gt;lastIndex-&gt;SDO_CLT;
<a name="l00661"></a>00661     j = 0;
<a name="l00662"></a>00662     <span class="keywordflow">if</span>(offset) <span class="keywordflow">while</span> (offset &lt;= lastIndex) {
<a name="l00663"></a>00663        <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 3) {
<a name="l00664"></a>00664          MSG_ERR(0x1A63, <span class="stringliteral">&quot;Subindex 3  not found at index &quot;</span>, 0x1280 + j);
<a name="l00665"></a>00665          <span class="keywordflow">return</span> 0xFF;
<a name="l00666"></a>00666        }
<a name="l00667"></a>00667        <span class="comment">/* a) Looking for the cobid received. */</span>
<a name="l00668"></a>00668        pCobId = (UNS32*) d-&gt;objdict[offset].pSubindex[2].pObject;
<a name="l00669"></a>00669        if (*pCobId == UNS16_LE(m-&gt;<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a>) ) {
<a name="l00670"></a>00670          <span class="comment">/* b) cobid found, so reading the node id of the server. */</span>
<a name="l00671"></a>00671          pNodeId = (UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject;
<a name="l00672"></a>00672          whoami = SDO_CLIENT;
<a name="l00673"></a>00673          nodeId = *pNodeId;
<a name="l00674"></a>00674          MSG_WAR(0x3A64, <span class="stringliteral">&quot;proceedSDO. I am server. index : &quot;</span>, 0x1280 + j);
<a name="l00675"></a>00675          MSG_WAR(0x3A65, <span class="stringliteral">&quot;                 Server nodeId : &quot;</span>, nodeId);
<a name="l00676"></a>00676          <span class="keywordflow">break</span>;
<a name="l00677"></a>00677         }
<a name="l00678"></a>00678        j++;
<a name="l00679"></a>00679        offset++;
<a name="l00680"></a>00680     } <span class="comment">/* end while */</span>
<a name="l00681"></a>00681   }
<a name="l00682"></a>00682   <span class="keywordflow">if</span> (whoami == SDO_UNKNOWN) {
<a name="l00683"></a>00683     <span class="keywordflow">return</span> 0xFF;<span class="comment">/* This SDO was not for us ! */</span>
<a name="l00684"></a>00684   }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   <span class="comment">/* Test if the size of the SDO is ok */</span>
<a name="l00687"></a>00687   <span class="keywordflow">if</span> ( (*m).len != 8) {
<a name="l00688"></a>00688     MSG_ERR(0x1A67, <span class="stringliteral">&quot;Error size SDO. CobId  : &quot;</span>, UNS16_LE(m-&gt;<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a>));
<a name="l00689"></a>00689     <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, 0, 0, SDOABT_GENERAL_ERROR);
<a name="l00690"></a>00690     <span class="keywordflow">return</span> 0xFF;
<a name="l00691"></a>00691   }
<a name="l00692"></a>00692 
<a name="l00693"></a>00693   <span class="keywordflow">if</span> (whoami == SDO_CLIENT) {
<a name="l00694"></a>00694     MSG_WAR(0x3A68, <span class="stringliteral">&quot;I am CLIENT. Received SDO from nodeId : &quot;</span>, nodeId);
<a name="l00695"></a>00695   }
<a name="l00696"></a>00696   <span class="keywordflow">else</span> {
<a name="l00697"></a>00697     MSG_WAR(0x3A69, <span class="stringliteral">&quot;I am SERVER. Received SDO cobId : &quot;</span>, UNS16_LE(m-&gt;<a class="code" href="structMessage.html#a0db105376ab9105abfcd15d56ea130d8">cob_id</a>));
<a name="l00698"></a>00698   }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700   <span class="comment">/* Testing the command specifier */</span>
<a name="l00701"></a>00701   <span class="comment">/* Allowed : cs = 0, 1, 2, 3, 4. (=  all except those for block tranfert). */</span>
<a name="l00702"></a>00702   <span class="comment">/* cs = other : Not allowed -&gt; abort. */</span>
<a name="l00703"></a>00703   <span class="keywordflow">switch</span> (<a class="code" href="sdo_8c.html#ace5a1634ff4089db3b228cdd5010c321">getSDOcs</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {
<a name="l00704"></a>00704 
<a name="l00705"></a>00705   <span class="keywordflow">case</span> 0:
<a name="l00706"></a>00706     <span class="comment">/* I am SERVER */</span>
<a name="l00707"></a>00707     <span class="keywordflow">if</span> (whoami == SDO_SERVER) {
<a name="l00708"></a>00708       <span class="comment">/* Receiving a download segment data. */</span>
<a name="l00709"></a>00709       <span class="comment">/* A SDO transfert should have been yet initiated. */</span>
<a name="l00710"></a>00710       err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line );
<a name="l00711"></a>00711       <span class="keywordflow">if</span> (!err)
<a name="l00712"></a>00712         err = d-&gt;transfers[line].state != SDO_DOWNLOAD_IN_PROGRESS;
<a name="l00713"></a>00713       <span class="keywordflow">if</span> (err) {
<a name="l00714"></a>00714         MSG_ERR(0x1A70, <span class="stringliteral">&quot;SDO error : Received download segment for unstarted trans. index 0x1200 + &quot;</span>,
<a name="l00715"></a>00715                 nodeId);
<a name="l00716"></a>00716         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);
<a name="l00717"></a>00717         <span class="keywordflow">return</span> 0xFF;
<a name="l00718"></a>00718       }
<a name="l00719"></a>00719       <span class="comment">/* Reset the wathdog */</span>
<a name="l00720"></a>00720       RestartSDO_TIMER(line)
<a name="l00721"></a>00721       MSG_WAR(0x3A71, <span class="stringliteral">&quot;Received SDO download segment defined at index 0x1200 + &quot;</span>, nodeId);
<a name="l00722"></a>00722       index = d-&gt;transfers[line].index;
<a name="l00723"></a>00723       subIndex = d-&gt;transfers[line].subIndex;
<a name="l00724"></a>00724       <span class="comment">/* Toggle test. */</span>
<a name="l00725"></a>00725       <span class="keywordflow">if</span> (d-&gt;transfers[line].toggle != <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {
<a name="l00726"></a>00726         MSG_ERR(0x1A72, <span class="stringliteral">&quot;SDO error : Toggle error : &quot;</span>, <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]));
<a name="l00727"></a>00727         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_TOGGLE_NOT_ALTERNED);
<a name="l00728"></a>00728         <span class="keywordflow">return</span> 0xFF;
<a name="l00729"></a>00729       }
<a name="l00730"></a>00730       <span class="comment">/* Nb of data to be downloaded */</span>
<a name="l00731"></a>00731       nbBytes = 7 - <a class="code" href="sdo_8c.html#ae5677ca12bfb71b06cbd6e99e9be0955">getSDOn3</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]);
<a name="l00732"></a>00732       <span class="comment">/* Store the data in the transfert structure. */</span>
<a name="l00733"></a>00733       err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55" title="Add data to an existant line.">SDOtoLine</a>(d, line, nbBytes, (*m).data + 1);
<a name="l00734"></a>00734       <span class="keywordflow">if</span> (err) {
<a name="l00735"></a>00735         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l00736"></a>00736         <span class="keywordflow">return</span> 0xFF;
<a name="l00737"></a>00737       }
<a name="l00738"></a>00738       <span class="comment">/* Sending the SDO response, CS = 1 */</span>
<a name="l00739"></a>00739       sdo.nodeId = *d-&gt;bDeviceNodeId; <span class="comment">/* The node id of the server, (here it is the sender). */</span>
<a name="l00740"></a>00740       sdo.body.data[0] = (1 &lt;&lt; 5) | (d-&gt;transfers[line].toggle &lt;&lt; 4);
<a name="l00741"></a>00741       <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)
<a name="l00742"></a>00742         sdo.body.data[i] = 0;
<a name="l00743"></a>00743       MSG_WAR(0x3A73, <span class="stringliteral">&quot;SDO. Send response to download request defined at index 0x1200 + &quot;</span>, nodeId);
<a name="l00744"></a>00744       <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l00745"></a>00745       <span class="comment">/* Inverting the toggle for the next segment. */</span>
<a name="l00746"></a>00746       d-&gt;transfers[line].toggle = ! d-&gt;transfers[line].toggle &amp; 1;
<a name="l00747"></a>00747       <span class="comment">/* If it was the last segment, */</span>
<a name="l00748"></a>00748       <span class="keywordflow">if</span> (<a class="code" href="sdo_8c.html#ae5a2dafe8497bff1fd88f881ea74414d">getSDOc</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {
<a name="l00749"></a>00749         <span class="comment">/* Transfering line data to object dictionary. */</span>
<a name="l00750"></a>00750         <span class="comment">/* The code does not use the &quot;d&quot; of initiate frame. So it is safe if e=s=0 */</span>
<a name="l00751"></a>00751         errorCode = <a class="code" href="sdo_8c.html#a2eb5309dca3a7363da5e5e7230b85d58" title="Copy the data received from the SDO line transfert to the object dictionary.">SDOlineToObjdict</a>(d, line);
<a name="l00752"></a>00752         <span class="keywordflow">if</span> (errorCode) {
<a name="l00753"></a>00753           MSG_ERR(0x1A54, <span class="stringliteral">&quot;SDO error : Unable to copy the data in the object dictionary&quot;</span>, 0);
<a name="l00754"></a>00754           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, errorCode);
<a name="l00755"></a>00755           <span class="keywordflow">return</span> 0xFF;
<a name="l00756"></a>00756         }
<a name="l00757"></a>00757         <span class="comment">/* Release of the line */</span>
<a name="l00758"></a>00758         <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>(d, line);
<a name="l00759"></a>00759         MSG_WAR(0x3A74, <span class="stringliteral">&quot;SDO. End of download defined at index 0x1200 + &quot;</span>, nodeId);
<a name="l00760"></a>00760       }
<a name="l00761"></a>00761     } <span class="comment">/* end if SERVER */</span>
<a name="l00762"></a>00762     <span class="keywordflow">else</span> { <span class="comment">/* if CLIENT */</span>
<a name="l00763"></a>00763       <span class="comment">/* I am CLIENT */</span>
<a name="l00764"></a>00764       <span class="comment">/* It is a request for a previous upload segment. We should find a line opened for this.*/</span>
<a name="l00765"></a>00765       err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line);
<a name="l00766"></a>00766       <span class="keywordflow">if</span> (!err)
<a name="l00767"></a>00767         err = d-&gt;transfers[line].state != SDO_UPLOAD_IN_PROGRESS;
<a name="l00768"></a>00768       <span class="keywordflow">if</span> (err) {
<a name="l00769"></a>00769         MSG_ERR(0x1A75, <span class="stringliteral">&quot;SDO error : Received segment response for unknown trans. from nodeId&quot;</span>, nodeId);
<a name="l00770"></a>00770         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);
<a name="l00771"></a>00771         <span class="keywordflow">return</span> 0xFF;
<a name="l00772"></a>00772       }
<a name="l00773"></a>00773       <span class="comment">/* Reset the wathdog */</span>
<a name="l00774"></a>00774       RestartSDO_TIMER(line)
<a name="l00775"></a>00775       index = d-&gt;transfers[line].index;
<a name="l00776"></a>00776       subIndex = d-&gt;transfers[line].subIndex;
<a name="l00777"></a>00777       <span class="comment">/* test of the toggle; */</span>
<a name="l00778"></a>00778       <span class="keywordflow">if</span> (d-&gt;transfers[line].toggle != <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {
<a name="l00779"></a>00779         MSG_ERR(0x1A76, <span class="stringliteral">&quot;SDO error : Received segment response Toggle error. from nodeId&quot;</span>, nodeId);
<a name="l00780"></a>00780         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_TOGGLE_NOT_ALTERNED);
<a name="l00781"></a>00781         <span class="keywordflow">return</span> 0xFF;
<a name="l00782"></a>00782       }
<a name="l00783"></a>00783       <span class="comment">/* nb of data to be uploaded */</span>
<a name="l00784"></a>00784       nbBytes = 7 - <a class="code" href="sdo_8c.html#ae5677ca12bfb71b06cbd6e99e9be0955">getSDOn3</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]);
<a name="l00785"></a>00785       <span class="comment">/* Storing the data in the line structure. */</span>
<a name="l00786"></a>00786       err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55" title="Add data to an existant line.">SDOtoLine</a>(d, line, nbBytes, (*m).data + 1);
<a name="l00787"></a>00787       <span class="keywordflow">if</span> (err) {
<a name="l00788"></a>00788         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l00789"></a>00789         <span class="keywordflow">return</span> 0xFF;
<a name="l00790"></a>00790       }
<a name="l00791"></a>00791       <span class="comment">/* Inverting the toggle for the next segment. */</span>
<a name="l00792"></a>00792       d-&gt;transfers[line].toggle = ! d-&gt;transfers[line].toggle &amp; 1;
<a name="l00793"></a>00793       <span class="comment">/* If it was the last segment,*/</span>
<a name="l00794"></a>00794       <span class="keywordflow">if</span> ( <a class="code" href="sdo_8c.html#ae5a2dafe8497bff1fd88f881ea74414d">getSDOc</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {
<a name="l00795"></a>00795         <span class="comment">/* Put in state finished */</span>
<a name="l00796"></a>00796         <span class="comment">/* The code is safe for the case e=s=0 in initiate frame. */</span>
<a name="l00797"></a>00797         StopSDO_TIMER(line)
<a name="l00798"></a>00798         d-&gt;transfers[line].state = SDO_FINISHED;
<a name="l00799"></a>00799         <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         MSG_WAR(0x3A77, <span class="stringliteral">&quot;SDO. End of upload from node : &quot;</span>, nodeId);
<a name="l00802"></a>00802       }
<a name="l00803"></a>00803       <span class="keywordflow">else</span> { <span class="comment">/* more segments to receive */</span>
<a name="l00804"></a>00804              <span class="comment">/* Sending the request for the next segment. */</span>
<a name="l00805"></a>00805         sdo.nodeId = nodeId;
<a name="l00806"></a>00806         sdo.body.data[0] = (3 &lt;&lt; 5) | (d-&gt;transfers[line].toggle &lt;&lt; 4);
<a name="l00807"></a>00807         <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)
<a name="l00808"></a>00808           sdo.body.data[i] = 0;
<a name="l00809"></a>00809         <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l00810"></a>00810         MSG_WAR(0x3A78, <span class="stringliteral">&quot;SDO send upload segment request to nodeId&quot;</span>, nodeId);
<a name="l00811"></a>00811       }
<a name="l00812"></a>00812     } <span class="comment">/* End if CLIENT */</span>
<a name="l00813"></a>00813     <span class="keywordflow">break</span>;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815   <span class="keywordflow">case</span> 1:
<a name="l00816"></a>00816     <span class="comment">/* I am SERVER */</span>
<a name="l00817"></a>00817     <span class="comment">/* Receive of an initiate download */</span>
<a name="l00818"></a>00818     <span class="keywordflow">if</span> (whoami == SDO_SERVER) {
<a name="l00819"></a>00819       index = <a class="code" href="sdo_8c.html#ad9b34e26bf67f1251f3bb364756e17f1">getSDOindex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[1],m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[2]);
<a name="l00820"></a>00820       subIndex = <a class="code" href="sdo_8c.html#a52a96f6fa6083f6b291133135b7155a8">getSDOsubIndex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[3]);
<a name="l00821"></a>00821       MSG_WAR(0x3A79, <span class="stringliteral">&quot;Received SDO Initiate Download (to store data) defined at index 0x1200 + &quot;</span>,
<a name="l00822"></a>00822               nodeId);
<a name="l00823"></a>00823       MSG_WAR(0x3A80, <span class="stringliteral">&quot;Writing at index : &quot;</span>, index);
<a name="l00824"></a>00824       MSG_WAR(0x3A80, <span class="stringliteral">&quot;Writing at subIndex : &quot;</span>, subIndex);
<a name="l00825"></a>00825 
<a name="l00826"></a>00826       <span class="comment">/* Search if a SDO transfert have been yet initiated */</span>
<a name="l00827"></a>00827       err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line );
<a name="l00828"></a>00828       <span class="keywordflow">if</span> (! err) {
<a name="l00829"></a>00829         MSG_ERR(0x1A81, <span class="stringliteral">&quot;SDO error : Transmission yet started.&quot;</span>, 0);
<a name="l00830"></a>00830         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);
<a name="l00831"></a>00831         <span class="keywordflow">return</span> 0xFF;
<a name="l00832"></a>00832       }
<a name="l00833"></a>00833       <span class="comment">/* No line on use. Great ! */</span>
<a name="l00834"></a>00834       <span class="comment">/* Try to open a new line. */</span>
<a name="l00835"></a>00835       err = <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252" title="Search for an unused line in the transfers array to store a new SDO. ie a line which value of the fie...">getSDOfreeLine</a>( d, whoami, &amp;line );
<a name="l00836"></a>00836       <span class="keywordflow">if</span> (err) {
<a name="l00837"></a>00837         MSG_ERR(0x1A82, <span class="stringliteral">&quot;SDO error : No line free, too many SDO in progress. Aborted.&quot;</span>, 0);
<a name="l00838"></a>00838         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);
<a name="l00839"></a>00839         <span class="keywordflow">return</span> 0xFF;
<a name="l00840"></a>00840       }
<a name="l00841"></a>00841       <a class="code" href="sdo_8c.html#ab9c873a15f55b29112b5527a6cc6898d" title="Initialize some fields of the structure.">initSDOline</a>(d, line, nodeId, index, subIndex, SDO_DOWNLOAD_IN_PROGRESS);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843       <span class="keywordflow">if</span> (<a class="code" href="sdo_8c.html#acf60675f20de8746e279dce3a5c8e3c6">getSDOe</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) { <span class="comment">/* If SDO expedited */</span>
<a name="l00844"></a>00844         <span class="comment">/* nb of data to be downloaded */</span>
<a name="l00845"></a>00845         nbBytes = 4 - <a class="code" href="sdo_8c.html#adfd3877d80f6b903b491a115e587bd14">getSDOn2</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]);
<a name="l00846"></a>00846         <span class="comment">/* Storing the data in the line structure. */</span>
<a name="l00847"></a>00847         d-&gt;transfers[line].count = nbBytes;
<a name="l00848"></a>00848         err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55" title="Add data to an existant line.">SDOtoLine</a>(d, line, nbBytes, (*m).data + 4);
<a name="l00849"></a>00849 
<a name="l00850"></a>00850         <span class="keywordflow">if</span> (err) {
<a name="l00851"></a>00851           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l00852"></a>00852           <span class="keywordflow">return</span> 0xFF;
<a name="l00853"></a>00853         }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855         <span class="comment">/* SDO expedited -&gt; transfert finished. Data can be stored in the dictionary. */</span>
<a name="l00856"></a>00856         <span class="comment">/*The line will be reseted when it is downloading in the dictionary. */</span>
<a name="l00857"></a>00857         MSG_WAR(0x3A83, <span class="stringliteral">&quot;SDO Initiate Download is an expedited transfert. Finished.: &quot;</span>, nodeId);
<a name="l00858"></a>00858         <span class="comment">/* Transfering line data to object dictionary. */</span>
<a name="l00859"></a>00859         errorCode = <a class="code" href="sdo_8c.html#a2eb5309dca3a7363da5e5e7230b85d58" title="Copy the data received from the SDO line transfert to the object dictionary.">SDOlineToObjdict</a>(d, line);
<a name="l00860"></a>00860         <span class="keywordflow">if</span> (errorCode) {
<a name="l00861"></a>00861           MSG_ERR(0x1A84, <span class="stringliteral">&quot;SDO error : Unable to copy the data in the object dictionary&quot;</span>, 0);
<a name="l00862"></a>00862           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, errorCode);
<a name="l00863"></a>00863           <span class="keywordflow">return</span> 0xFF;
<a name="l00864"></a>00864         }
<a name="l00865"></a>00865         <span class="comment">/* Release of the line. */</span>
<a name="l00866"></a>00866         <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>(d, line);
<a name="l00867"></a>00867       }
<a name="l00868"></a>00868       <span class="keywordflow">else</span> {<span class="comment">/* So, if it is not an expedited transfert */</span>
<a name="l00869"></a>00869         <span class="keywordflow">if</span> (<a class="code" href="sdo_8c.html#af7f9e9bc3d59c9772d4c767b199dcf89">getSDOs</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {
<a name="l00870"></a>00870           nbBytes = (m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[4]) + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[5])&lt;&lt;8) + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[6])&lt;&lt;16) + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[7])&lt;&lt;24);
<a name="l00871"></a>00871           err = <a class="code" href="sdo_8c.html#a7ca56a650c5daaa24c89370f3b3d7bb0" title="Store in the line structure the nb of bytes which must be transmited (or received).">setSDOlineRestBytes</a>(d, nodeId, nbBytes);
<a name="l00872"></a>00872           <span class="keywordflow">if</span> (err) {
<a name="l00873"></a>00873             <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l00874"></a>00874             <span class="keywordflow">return</span> 0xFF;
<a name="l00875"></a>00875           }
<a name="l00876"></a>00876         }
<a name="l00877"></a>00877       }
<a name="l00878"></a>00878       <span class="comment">/*Sending a SDO, cs=3*/</span>
<a name="l00879"></a>00879       sdo.nodeId = *d-&gt;bDeviceNodeId; <span class="comment">/* The node id of the server, (here it is the sender).*/</span>
<a name="l00880"></a>00880       sdo.body.data[0] = 3 &lt;&lt; 5;
<a name="l00881"></a>00881       sdo.body.data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span>
<a name="l00882"></a>00882       sdo.body.data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span>
<a name="l00883"></a>00883       sdo.body.data[3] = subIndex;
<a name="l00884"></a>00884       <span class="keywordflow">for</span> (i = 4 ; i &lt; 8 ; i++)
<a name="l00885"></a>00885                 sdo.body.data[i] = 0;
<a name="l00886"></a>00886       <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l00887"></a>00887     } <span class="comment">/* end if I am SERVER */</span>
<a name="l00888"></a>00888     <span class="keywordflow">else</span> {
<a name="l00889"></a>00889       <span class="comment">/* I am CLIENT */</span>
<a name="l00890"></a>00890       <span class="comment">/* It is a response for a previous download segment. We should find a line opened for this. */</span>
<a name="l00891"></a>00891       err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line);
<a name="l00892"></a>00892       <span class="keywordflow">if</span> (!err)
<a name="l00893"></a>00893         err = d-&gt;transfers[line].state != SDO_DOWNLOAD_IN_PROGRESS;
<a name="l00894"></a>00894       <span class="keywordflow">if</span> (err) {
<a name="l00895"></a>00895         MSG_ERR(0x1A85, <span class="stringliteral">&quot;SDO error : Received segment response for unknown trans. from nodeId&quot;</span>, nodeId);
<a name="l00896"></a>00896         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);
<a name="l00897"></a>00897         <span class="keywordflow">return</span> 0xFF;
<a name="l00898"></a>00898       }
<a name="l00899"></a>00899       <span class="comment">/* Reset the wathdog */</span>
<a name="l00900"></a>00900       RestartSDO_TIMER(line)
<a name="l00901"></a>00901       index = d-&gt;transfers[line].index;
<a name="l00902"></a>00902       subIndex = d-&gt;transfers[line].subIndex;
<a name="l00903"></a>00903       <span class="comment">/* test of the toggle; */</span>
<a name="l00904"></a>00904       <span class="keywordflow">if</span> (d-&gt;transfers[line].toggle != <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {
<a name="l00905"></a>00905         MSG_ERR(0x1A86, <span class="stringliteral">&quot;SDO error : Received segment response Toggle error. from nodeId&quot;</span>, nodeId);
<a name="l00906"></a>00906         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_TOGGLE_NOT_ALTERNED);
<a name="l00907"></a>00907         <span class="keywordflow">return</span> 0xFF;
<a name="l00908"></a>00908       }
<a name="l00909"></a>00909 
<a name="l00910"></a>00910       <span class="comment">/* End transmission or downloading next segment. We need to know if it will be the last one. */</span>
<a name="l00911"></a>00911       <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb" title="Bytes in the line structure which must be transmited (or received).">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);
<a name="l00912"></a>00912       <span class="keywordflow">if</span> (nbBytes == 0) {
<a name="l00913"></a>00913         MSG_WAR(0x3A87, <span class="stringliteral">&quot;SDO End download. segment response received. OK. from nodeId&quot;</span>, nodeId);
<a name="l00914"></a>00914         StopSDO_TIMER(line)
<a name="l00915"></a>00915         d-&gt;transfers[line].state = SDO_FINISHED;
<a name="l00916"></a>00916         <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);
<a name="l00917"></a>00917         <span class="keywordflow">return</span> 0x00;
<a name="l00918"></a>00918       }
<a name="l00919"></a>00919       <span class="comment">/* At least one transfer to send. */</span>
<a name="l00920"></a>00920       <span class="keywordflow">if</span> (nbBytes &gt; 7) {
<a name="l00921"></a>00921         <span class="comment">/* several segments to download.*/</span>
<a name="l00922"></a>00922         <span class="comment">/* code to send the next segment. (cs = 0; c = 0) */</span>
<a name="l00923"></a>00923         d-&gt;transfers[line].toggle = ! d-&gt;transfers[line].toggle &amp; 1;
<a name="l00924"></a>00924         sdo.nodeId = nodeId; <span class="comment">/* The server node Id; */</span>
<a name="l00925"></a>00925         sdo.body.data[0] = (d-&gt;transfers[line].toggle &lt;&lt; 4);
<a name="l00926"></a>00926         err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e" title="Copy data from an existant line in the argument &amp;quot;* data&amp;quot;.">lineToSDO</a>(d, line, 7, sdo.body.data + 1);
<a name="l00927"></a>00927         <span class="keywordflow">if</span> (err) {
<a name="l00928"></a>00928           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l00929"></a>00929           <span class="keywordflow">return</span> 0xFF;
<a name="l00930"></a>00930         }
<a name="l00931"></a>00931       }
<a name="l00932"></a>00932       <span class="keywordflow">else</span> {
<a name="l00933"></a>00933         <span class="comment">/* Last segment. */</span>
<a name="l00934"></a>00934         <span class="comment">/* code to send the last segment. (cs = 0; c = 1)*/</span>
<a name="l00935"></a>00935         d-&gt;transfers[line].toggle = ! d-&gt;transfers[line].toggle &amp; 1;
<a name="l00936"></a>00936         sdo.nodeId = nodeId; <span class="comment">/* The server node Id; */</span>
<a name="l00937"></a>00937         sdo.body.data[0] = (UNS8)((d-&gt;transfers[line].toggle &lt;&lt; 4) | ((7 - nbBytes) &lt;&lt; 1) | 1);
<a name="l00938"></a>00938         err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e" title="Copy data from an existant line in the argument &amp;quot;* data&amp;quot;.">lineToSDO</a>(d, line, nbBytes, sdo.body.data + 1);
<a name="l00939"></a>00939         <span class="keywordflow">if</span> (err) {
<a name="l00940"></a>00940           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l00941"></a>00941           <span class="keywordflow">return</span> 0xFF;
<a name="l00942"></a>00942         }
<a name="l00943"></a>00943         <span class="keywordflow">for</span> (i = nbBytes + 1 ; i &lt; 8 ; i++)
<a name="l00944"></a>00944           sdo.body.data[i] = 0;
<a name="l00945"></a>00945       }
<a name="l00946"></a>00946       MSG_WAR(0x3A88, <span class="stringliteral">&quot;SDO sending download segment to nodeId&quot;</span>, nodeId);
<a name="l00947"></a>00947       <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l00948"></a>00948     } <span class="comment">/* end if I am a CLIENT */</span>
<a name="l00949"></a>00949     <span class="keywordflow">break</span>;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951   <span class="keywordflow">case</span> 2:
<a name="l00952"></a>00952     <span class="comment">/* I am SERVER */</span>
<a name="l00953"></a>00953     <span class="comment">/* Receive of an initiate upload.*/</span>
<a name="l00954"></a>00954     <span class="keywordflow">if</span> (whoami == SDO_SERVER) {
<a name="l00955"></a>00955       index = <a class="code" href="sdo_8c.html#ad9b34e26bf67f1251f3bb364756e17f1">getSDOindex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[1],m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[2]);
<a name="l00956"></a>00956       subIndex = <a class="code" href="sdo_8c.html#a52a96f6fa6083f6b291133135b7155a8">getSDOsubIndex</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[3]);
<a name="l00957"></a>00957       MSG_WAR(0x3A89, <span class="stringliteral">&quot;Received SDO Initiate upload (to send data) defined at index 0x1200 + &quot;</span>,
<a name="l00958"></a>00958               nodeId);
<a name="l00959"></a>00959       MSG_WAR(0x3A90, <span class="stringliteral">&quot;Reading at index : &quot;</span>, index);
<a name="l00960"></a>00960       MSG_WAR(0x3A91, <span class="stringliteral">&quot;Reading at subIndex : &quot;</span>, subIndex);
<a name="l00961"></a>00961       <span class="comment">/* Search if a SDO transfert have been yet initiated*/</span>
<a name="l00962"></a>00962       err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line );
<a name="l00963"></a>00963       <span class="keywordflow">if</span> (! err) {
<a name="l00964"></a>00964             MSG_ERR(0x1A92, <span class="stringliteral">&quot;SDO error : Transmission yet started at line : &quot;</span>, line);
<a name="l00965"></a>00965         MSG_WAR(0x3A93, <span class="stringliteral">&quot;nodeId = &quot;</span>, nodeId);
<a name="l00966"></a>00966             <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);
<a name="l00967"></a>00967             <span class="keywordflow">return</span> 0xFF;
<a name="l00968"></a>00968       }
<a name="l00969"></a>00969       <span class="comment">/* No line on use. Great !*/</span>
<a name="l00970"></a>00970       <span class="comment">/* Try to open a new line.*/</span>
<a name="l00971"></a>00971       err = <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252" title="Search for an unused line in the transfers array to store a new SDO. ie a line which value of the fie...">getSDOfreeLine</a>( d, whoami, &amp;line );
<a name="l00972"></a>00972       <span class="keywordflow">if</span> (err) {
<a name="l00973"></a>00973         MSG_ERR(0x1A71, <span class="stringliteral">&quot;SDO error : No line free, too many SDO in progress. Aborted.&quot;</span>, 0);
<a name="l00974"></a>00974         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_LOCAL_CTRL_ERROR);
<a name="l00975"></a>00975         <span class="keywordflow">return</span> 0xFF;
<a name="l00976"></a>00976       }
<a name="l00977"></a>00977       <a class="code" href="sdo_8c.html#ab9c873a15f55b29112b5527a6cc6898d" title="Initialize some fields of the structure.">initSDOline</a>(d, line, nodeId, index, subIndex, SDO_UPLOAD_IN_PROGRESS);
<a name="l00978"></a>00978       <span class="comment">/* Transfer data from dictionary to the line structure. */</span>
<a name="l00979"></a>00979       errorCode = <a class="code" href="sdo_8c.html#a29427a80fd1aeabff30bf0602fbc220f" title="Copy the data from the object dictionary to the SDO line for a network transfert.">objdictToSDOline</a>(d, line);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981       <span class="keywordflow">if</span> (errorCode) {
<a name="l00982"></a>00982         MSG_ERR(0x1A94, <span class="stringliteral">&quot;SDO error : Unable to copy the data from object dictionary. Err code : &quot;</span>,
<a name="l00983"></a>00983                 errorCode);
<a name="l00984"></a>00984         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, errorCode);
<a name="l00985"></a>00985         <span class="keywordflow">return</span> 0xFF;
<a name="l00986"></a>00986         }
<a name="l00987"></a>00987       <span class="comment">/* Preparing the response.*/</span>
<a name="l00988"></a>00988       <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb" title="Bytes in the line structure which must be transmited (or received).">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);   <span class="comment">/* Nb bytes to transfer ? */</span>
<a name="l00989"></a>00989       sdo.nodeId = nodeId; <span class="comment">/* The server node Id; */</span>
<a name="l00990"></a>00990       <span class="keywordflow">if</span> (nbBytes &gt; 4) {
<a name="l00991"></a>00991         <span class="comment">/* normal transfert. (segmented). */</span>
<a name="l00992"></a>00992         <span class="comment">/* code to send the initiate upload response. (cs = 2) */</span>
<a name="l00993"></a>00993         sdo.body.data[0] = (2 &lt;&lt; 5) | 1;
<a name="l00994"></a>00994         sdo.body.data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span>
<a name="l00995"></a>00995         sdo.body.data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span>
<a name="l00996"></a>00996         sdo.body.data[3] = subIndex;
<a name="l00997"></a>00997     sdo.body.data[4] = (UNS8)nbBytes; <span class="comment">/* Limitation of canfestival2 : Max tranfert is 256 bytes.*/</span>
<a name="l00998"></a>00998         <span class="comment">/* It takes too much memory to upgrate to 2^32 because the size of data is also coded */</span>
<a name="l00999"></a>00999         <span class="comment">/* in the object dictionary, at every index and subindex. */</span>
<a name="l01000"></a>01000         <span class="keywordflow">for</span> (i = 5 ; i &lt; 8 ; i++)
<a name="l01001"></a>01001           sdo.body.data[i] = 0;
<a name="l01002"></a>01002         MSG_WAR(0x3A95, <span class="stringliteral">&quot;SDO. Sending normal upload initiate response defined at index 0x1200 + &quot;</span>, nodeId);
<a name="l01003"></a>01003         <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l01004"></a>01004       }
<a name="l01005"></a>01005       <span class="keywordflow">else</span> {
<a name="l01006"></a>01006         <span class="comment">/* Expedited upload. (cs = 2 ; e = 1) */</span>
<a name="l01007"></a>01007         sdo.body.data[0] = (UNS8)((2 &lt;&lt; 5) | ((4 - nbBytes) &lt;&lt; 2) | 3);
<a name="l01008"></a>01008         sdo.body.data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span>
<a name="l01009"></a>01009         sdo.body.data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span>
<a name="l01010"></a>01010         sdo.body.data[3] = subIndex;
<a name="l01011"></a>01011         err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e" title="Copy data from an existant line in the argument &amp;quot;* data&amp;quot;.">lineToSDO</a>(d, line, nbBytes, sdo.body.data + 4);
<a name="l01012"></a>01012         <span class="keywordflow">if</span> (err) {
<a name="l01013"></a>01013           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l01014"></a>01014           <span class="keywordflow">return</span> 0xFF;
<a name="l01015"></a>01015         }
<a name="l01016"></a>01016         <span class="keywordflow">for</span> (i = 4 + nbBytes ; i &lt; 8 ; i++)
<a name="l01017"></a>01017           sdo.body.data[i] = 0;
<a name="l01018"></a>01018         MSG_WAR(0x3A96, <span class="stringliteral">&quot;SDO. Sending expedited upload initiate response defined at index 0x1200 + &quot;</span>,
<a name="l01019"></a>01019                 nodeId);
<a name="l01020"></a>01020         <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l01021"></a>01021         <span class="comment">/* Release the line.*/</span>
<a name="l01022"></a>01022         <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>(d, line);
<a name="l01023"></a>01023       }
<a name="l01024"></a>01024     } <span class="comment">/* end if I am SERVER*/</span>
<a name="l01025"></a>01025     <span class="keywordflow">else</span> {
<a name="l01026"></a>01026       <span class="comment">/* I am CLIENT */</span>
<a name="l01027"></a>01027       <span class="comment">/* It is the response for the previous initiate upload request.*/</span>
<a name="l01028"></a>01028       <span class="comment">/* We should find a line opened for this. */</span>
<a name="l01029"></a>01029       err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line);
<a name="l01030"></a>01030       <span class="keywordflow">if</span> (!err)
<a name="l01031"></a>01031         err = d-&gt;transfers[line].state != SDO_UPLOAD_IN_PROGRESS;
<a name="l01032"></a>01032       <span class="keywordflow">if</span> (err) {
<a name="l01033"></a>01033         MSG_ERR(0x1A97, <span class="stringliteral">&quot;SDO error : Received response for unknown upload request from nodeId&quot;</span>, nodeId);
<a name="l01034"></a>01034         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);
<a name="l01035"></a>01035         <span class="keywordflow">return</span> 0xFF;
<a name="l01036"></a>01036       }
<a name="l01037"></a>01037       <span class="comment">/* Reset the wathdog */</span>
<a name="l01038"></a>01038       RestartSDO_TIMER(line)
<a name="l01039"></a>01039       index = d-&gt;transfers[line].index;
<a name="l01040"></a>01040       subIndex = d-&gt;transfers[line].subIndex;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042       <span class="keywordflow">if</span> (<a class="code" href="sdo_8c.html#acf60675f20de8746e279dce3a5c8e3c6">getSDOe</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) { <span class="comment">/* If SDO expedited */</span>
<a name="l01043"></a>01043         <span class="comment">/* nb of data to be uploaded */</span>
<a name="l01044"></a>01044           nbBytes = 4 - <a class="code" href="sdo_8c.html#adfd3877d80f6b903b491a115e587bd14">getSDOn2</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]);
<a name="l01045"></a>01045         <span class="comment">/* Storing the data in the line structure. */</span>
<a name="l01046"></a>01046         err = <a class="code" href="sdo_8c.html#a5efdbb02d210aad29c6d162600d3ae55" title="Add data to an existant line.">SDOtoLine</a>(d, line, nbBytes, (*m).data + 4);
<a name="l01047"></a>01047         <span class="keywordflow">if</span> (err) {
<a name="l01048"></a>01048           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l01049"></a>01049           <span class="keywordflow">return</span> 0xFF;
<a name="l01050"></a>01050         }
<a name="l01051"></a>01051         <span class="comment">/* SDO expedited -&gt; transfert finished. data are available via  getReadResultNetworkDict(). */</span>
<a name="l01052"></a>01052         MSG_WAR(0x3A98, <span class="stringliteral">&quot;SDO expedited upload finished. Response received from node : &quot;</span>, nodeId);
<a name="l01053"></a>01053         StopSDO_TIMER(line)
<a name="l01054"></a>01054         d-&gt;transfers[line].count = nbBytes;
<a name="l01055"></a>01055         d-&gt;transfers[line].state = SDO_FINISHED;
<a name="l01056"></a>01056         <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);
<a name="l01057"></a>01057         <span class="keywordflow">return</span> 0;
<a name="l01058"></a>01058       }
<a name="l01059"></a>01059       <span class="keywordflow">else</span> { <span class="comment">/* So, if it is not an expedited transfert */</span>
<a name="l01060"></a>01060         <span class="comment">/* Storing the nb of data to receive. */</span>
<a name="l01061"></a>01061         <span class="keywordflow">if</span> (<a class="code" href="sdo_8c.html#af7f9e9bc3d59c9772d4c767b199dcf89">getSDOs</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {
<a name="l01062"></a>01062           nbBytes = m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[4] + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[5])&lt;&lt;8) + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[6])&lt;&lt;16) + ((UNS32)(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[7])&lt;&lt;24);
<a name="l01063"></a>01063           err = <a class="code" href="sdo_8c.html#a7ca56a650c5daaa24c89370f3b3d7bb0" title="Store in the line structure the nb of bytes which must be transmited (or received).">setSDOlineRestBytes</a>(d, line, nbBytes);
<a name="l01064"></a>01064           <span class="keywordflow">if</span> (err) {
<a name="l01065"></a>01065             <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l01066"></a>01066             <span class="keywordflow">return</span> 0xFF;
<a name="l01067"></a>01067           }
<a name="l01068"></a>01068         }
<a name="l01069"></a>01069         <span class="comment">/* Requesting next segment. (cs = 3) */</span>
<a name="l01070"></a>01070         sdo.nodeId = nodeId;
<a name="l01071"></a>01071         sdo.body.data[0] = 3 &lt;&lt; 5;
<a name="l01072"></a>01072         <span class="keywordflow">for</span> (i = 1 ; i &lt; 8 ; i++)
<a name="l01073"></a>01073           sdo.body.data[i] = 0;
<a name="l01074"></a>01074         MSG_WAR(0x3A99, <span class="stringliteral">&quot;SDO. Sending upload segment request to node : &quot;</span>, nodeId);
<a name="l01075"></a>01075         <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l01076"></a>01076       }
<a name="l01077"></a>01077     } <span class="comment">/* End if CLIENT */</span>
<a name="l01078"></a>01078     <span class="keywordflow">break</span>;
<a name="l01079"></a>01079 
<a name="l01080"></a>01080   <span class="keywordflow">case</span> 3:
<a name="l01081"></a>01081     <span class="comment">/* I am SERVER */</span>
<a name="l01082"></a>01082     <span class="keywordflow">if</span> (whoami == SDO_SERVER) {
<a name="l01083"></a>01083       <span class="comment">/* Receiving a upload segment. */</span>
<a name="l01084"></a>01084       <span class="comment">/* A SDO transfert should have been yet initiated. */</span>
<a name="l01085"></a>01085       err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line );
<a name="l01086"></a>01086       <span class="keywordflow">if</span> (!err)
<a name="l01087"></a>01087         err = d-&gt;transfers[line].state != SDO_UPLOAD_IN_PROGRESS;
<a name="l01088"></a>01088       <span class="keywordflow">if</span> (err) {
<a name="l01089"></a>01089         MSG_ERR(0x1AA0, <span class="stringliteral">&quot;SDO error : Received upload segment for unstarted trans. index 0x1200 + &quot;</span>,
<a name="l01090"></a>01090                 nodeId);
<a name="l01091"></a>01091         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);
<a name="l01092"></a>01092         <span class="keywordflow">return</span> 0xFF;
<a name="l01093"></a>01093       }
<a name="l01094"></a>01094       <span class="comment">/* Reset the wathdog */</span>
<a name="l01095"></a>01095       RestartSDO_TIMER(line)
<a name="l01096"></a>01096       MSG_WAR(0x3AA1, <span class="stringliteral">&quot;Received SDO upload segment defined at index 0x1200 + &quot;</span>, nodeId);
<a name="l01097"></a>01097       index = d-&gt;transfers[line].index;
<a name="l01098"></a>01098       subIndex = d-&gt;transfers[line].subIndex;
<a name="l01099"></a>01099       <span class="comment">/* Toggle test.*/</span>
<a name="l01100"></a>01100       <span class="keywordflow">if</span> (d-&gt;transfers[line].toggle != <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0])) {
<a name="l01101"></a>01101         MSG_ERR(0x1AA2, <span class="stringliteral">&quot;SDO error : Toggle error : &quot;</span>, <a class="code" href="sdo_8c.html#a464b29fd628d92426de0a841232bdd12">getSDOt</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]));
<a name="l01102"></a>01102         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_TOGGLE_NOT_ALTERNED);
<a name="l01103"></a>01103         <span class="keywordflow">return</span> 0xFF;
<a name="l01104"></a>01104       }
<a name="l01105"></a>01105       <span class="comment">/* Uploading next segment. We need to know if it will be the last one. */</span>
<a name="l01106"></a>01106       <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb" title="Bytes in the line structure which must be transmited (or received).">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);
<a name="l01107"></a>01107       <span class="keywordflow">if</span> (nbBytes &gt; 7) {
<a name="l01108"></a>01108         <span class="comment">/* The segment to transfer is not the last one.*/</span>
<a name="l01109"></a>01109         <span class="comment">/* code to send the next segment. (cs = 0; c = 0) */</span>
<a name="l01110"></a>01110         sdo.nodeId = nodeId; <span class="comment">/* The server node Id; */</span>
<a name="l01111"></a>01111         sdo.body.data[0] = (d-&gt;transfers[line].toggle &lt;&lt; 4);
<a name="l01112"></a>01112         err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e" title="Copy data from an existant line in the argument &amp;quot;* data&amp;quot;.">lineToSDO</a>(d, line, 7, sdo.body.data + 1);
<a name="l01113"></a>01113         <span class="keywordflow">if</span> (err) {
<a name="l01114"></a>01114           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l01115"></a>01115           <span class="keywordflow">return</span> 0xFF;
<a name="l01116"></a>01116         }
<a name="l01117"></a>01117         <span class="comment">/* Inverting the toggle for the next tranfert. */</span>
<a name="l01118"></a>01118         d-&gt;transfers[line].toggle = ! d-&gt;transfers[line].toggle &amp; 1;
<a name="l01119"></a>01119         MSG_WAR(0x3AA3, <span class="stringliteral">&quot;SDO. Sending upload segment defined at index 0x1200 + &quot;</span>, nodeId);
<a name="l01120"></a>01120         <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l01121"></a>01121       }
<a name="l01122"></a>01122       <span class="keywordflow">else</span> {
<a name="l01123"></a>01123         <span class="comment">/* Last segment. */</span>
<a name="l01124"></a>01124         <span class="comment">/* code to send the last segment. (cs = 0; c = 1) */</span>
<a name="l01125"></a>01125         sdo.nodeId = nodeId; 
<a name="l01126"></a>01126         sdo.body.data[0] = (UNS8)((d-&gt;transfers[line].toggle &lt;&lt; 4) | ((7 - nbBytes) &lt;&lt; 1) | 1);
<a name="l01127"></a>01127         err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e" title="Copy data from an existant line in the argument &amp;quot;* data&amp;quot;.">lineToSDO</a>(d, line, nbBytes, sdo.body.data + 1);
<a name="l01128"></a>01128         <span class="keywordflow">if</span> (err) {
<a name="l01129"></a>01129           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l01130"></a>01130           <span class="keywordflow">return</span> 0xFF;
<a name="l01131"></a>01131         }
<a name="l01132"></a>01132         <span class="keywordflow">for</span> (i = nbBytes + 1 ; i &lt; 8 ; i++)
<a name="l01133"></a>01133           sdo.body.data[i] = 0;
<a name="l01134"></a>01134         MSG_WAR(0x3AA4, <span class="stringliteral">&quot;SDO. Sending last upload segment defined at index 0x1200 + &quot;</span>, nodeId);
<a name="l01135"></a>01135         <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l01136"></a>01136         <span class="comment">/* Release the line */</span>
<a name="l01137"></a>01137         <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>(d, line);
<a name="l01138"></a>01138       }
<a name="l01139"></a>01139     } <span class="comment">/* end if SERVER*/</span>
<a name="l01140"></a>01140     <span class="keywordflow">else</span> {
<a name="l01141"></a>01141       <span class="comment">/* I am CLIENT */</span>
<a name="l01142"></a>01142       <span class="comment">/* It is the response for the previous initiate download request. */</span>
<a name="l01143"></a>01143       <span class="comment">/* We should find a line opened for this. */</span>
<a name="l01144"></a>01144       err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line);
<a name="l01145"></a>01145       <span class="keywordflow">if</span> (!err)
<a name="l01146"></a>01146         err = d-&gt;transfers[line].state != SDO_DOWNLOAD_IN_PROGRESS;
<a name="l01147"></a>01147       <span class="keywordflow">if</span> (err) {
<a name="l01148"></a>01148         MSG_ERR(0x1AA5, <span class="stringliteral">&quot;SDO error : Received response for unknown download request from nodeId&quot;</span>, nodeId);
<a name="l01149"></a>01149         <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, 0, 0, SDOABT_LOCAL_CTRL_ERROR);
<a name="l01150"></a>01150         <span class="keywordflow">return</span> 0xFF;
<a name="l01151"></a>01151       }
<a name="l01152"></a>01152       <span class="comment">/* Reset the watchdog */</span>
<a name="l01153"></a>01153       RestartSDO_TIMER(line)
<a name="l01154"></a>01154       index = d-&gt;transfers[line].index;
<a name="l01155"></a>01155       subIndex = d-&gt;transfers[line].subIndex;
<a name="l01156"></a>01156       <span class="comment">/* End transmission or requesting  next segment. */</span>
<a name="l01157"></a>01157       <a class="code" href="sdo_8c.html#a7654021041675c1389fd2d1b590ff7cb" title="Bytes in the line structure which must be transmited (or received).">getSDOlineRestBytes</a>(d, line, &amp;nbBytes);
<a name="l01158"></a>01158       <span class="keywordflow">if</span> (nbBytes == 0) {
<a name="l01159"></a>01159         MSG_WAR(0x3AA6, <span class="stringliteral">&quot;SDO End download expedited. Response received. from nodeId&quot;</span>, nodeId);
<a name="l01160"></a>01160         StopSDO_TIMER(line)
<a name="l01161"></a>01161         d-&gt;transfers[line].state = SDO_FINISHED;
<a name="l01162"></a>01162         <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);
<a name="l01163"></a>01163         <span class="keywordflow">return</span> 0x00;
<a name="l01164"></a>01164       }
<a name="l01165"></a>01165       <span class="keywordflow">if</span> (nbBytes &gt; 7) {
<a name="l01166"></a>01166         <span class="comment">/* more than one request to send */</span>
<a name="l01167"></a>01167         <span class="comment">/* code to send the next segment. (cs = 0; c = 0)       */</span>
<a name="l01168"></a>01168         sdo.nodeId = nodeId; 
<a name="l01169"></a>01169         sdo.body.data[0] = (d-&gt;transfers[line].toggle &lt;&lt; 4);
<a name="l01170"></a>01170         err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e" title="Copy data from an existant line in the argument &amp;quot;* data&amp;quot;.">lineToSDO</a>(d, line, 7, sdo.body.data + 1);
<a name="l01171"></a>01171         <span class="keywordflow">if</span> (err) {
<a name="l01172"></a>01172           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l01173"></a>01173           <span class="keywordflow">return</span> 0xFF;
<a name="l01174"></a>01174         }
<a name="l01175"></a>01175       }
<a name="l01176"></a>01176       <span class="keywordflow">else</span> {
<a name="l01177"></a>01177         <span class="comment">/* Last segment.*/</span>
<a name="l01178"></a>01178         <span class="comment">/* code to send the last segment. (cs = 0; c = 1)       */</span>
<a name="l01179"></a>01179         sdo.nodeId = nodeId; <span class="comment">/* The server node Id; */</span>
<a name="l01180"></a>01180         sdo.body.data[0] = (UNS8)((d-&gt;transfers[line].toggle &lt;&lt; 4) | ((7 - nbBytes) &lt;&lt; 1) | 1);
<a name="l01181"></a>01181         err = <a class="code" href="sdo_8c.html#a2b662491084d03f3ad43d280a45ef23e" title="Copy data from an existant line in the argument &amp;quot;* data&amp;quot;.">lineToSDO</a>(d, line, nbBytes, sdo.body.data + 1);
<a name="l01182"></a>01182         <span class="keywordflow">if</span> (err) {
<a name="l01183"></a>01183           <a class="code" href="sdo_8c.html#a2019db2a4d17e6d29c055cbae173e2b9" title="Called when an internal SDO abort occurs. Release the line * Only if server * If client, the line must be released manually in the core application. The reason of that is to permit the program to read the transfers structure before its reset, because many informations are stored on it : index, subindex, data received or trasmited, ... In all cases, sends a SDO abort.">failedSDO</a>(d, nodeId, whoami, index, subIndex, SDOABT_GENERAL_ERROR);
<a name="l01184"></a>01184           <span class="keywordflow">return</span> 0xFF;
<a name="l01185"></a>01185         }
<a name="l01186"></a>01186         <span class="keywordflow">for</span> (i = nbBytes + 1 ; i &lt; 8 ; i++)
<a name="l01187"></a>01187           sdo.body.data[i] = 0;
<a name="l01188"></a>01188       }
<a name="l01189"></a>01189       MSG_WAR(0x3AA7, <span class="stringliteral">&quot;SDO sending download segment to nodeId&quot;</span>, nodeId);
<a name="l01190"></a>01190       <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, whoami, sdo);
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     } <span class="comment">/* end if I am a CLIENT           */</span>
<a name="l01193"></a>01193     <span class="keywordflow">break</span>;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195    <span class="keywordflow">case</span> 4:
<a name="l01196"></a>01196      abortCode =
<a name="l01197"></a>01197       (UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[4] |
<a name="l01198"></a>01198       ((UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[5] &lt;&lt; 8) |
<a name="l01199"></a>01199       ((UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[6] &lt;&lt; 16) |
<a name="l01200"></a>01200       ((UNS32)m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[7] &lt;&lt; 24);
<a name="l01201"></a>01201     <span class="comment">/* Received SDO abort. */</span>
<a name="l01202"></a>01202     <span class="comment">/* Looking for the line concerned. */</span>
<a name="l01203"></a>01203     <span class="keywordflow">if</span> (whoami == SDO_SERVER) {
<a name="l01204"></a>01204       err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line );
<a name="l01205"></a>01205       <span class="keywordflow">if</span> (!err) {
<a name="l01206"></a>01206         <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>( d, line );
<a name="l01207"></a>01207         MSG_WAR(0x3AA8, <span class="stringliteral">&quot;SD0. Received SDO abort. Line released. Code : &quot;</span>, abortCode);
<a name="l01208"></a>01208       }
<a name="l01209"></a>01209       <span class="keywordflow">else</span>
<a name="l01210"></a>01210         MSG_WAR(0x3AA9, <span class="stringliteral">&quot;SD0. Received SDO abort. No line found. Code : &quot;</span>, abortCode);
<a name="l01211"></a>01211       <span class="comment">/* Tips : The end user has no way to know that the server node has received an abort SDO. */</span>
<a name="l01212"></a>01212       <span class="comment">/* Its is ok, I think.*/</span>
<a name="l01213"></a>01213     }
<a name="l01214"></a>01214     <span class="keywordflow">else</span> { <span class="comment">/* If I am CLIENT */</span>
<a name="l01215"></a>01215       err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>( d, nodeId, whoami, &amp;line );
<a name="l01216"></a>01216       <span class="keywordflow">if</span> (!err) {
<a name="l01217"></a>01217         <span class="comment">/* The line *must* be released by the core program. */</span>
<a name="l01218"></a>01218         StopSDO_TIMER(line)
<a name="l01219"></a>01219         d-&gt;transfers[line].state = SDO_ABORTED_RCV;
<a name="l01220"></a>01220         d-&gt;transfers[line].abortCode = abortCode;
<a name="l01221"></a>01221         MSG_WAR(0x3AB0, <span class="stringliteral">&quot;SD0. Received SDO abort. Line state ABORTED. Code : &quot;</span>, abortCode);
<a name="l01222"></a>01222         <span class="keywordflow">if</span>(d-&gt;transfers[line].Callback) (*d-&gt;transfers[line].Callback)(d,nodeId);
<a name="l01223"></a>01223       }
<a name="l01224"></a>01224       <span class="keywordflow">else</span>
<a name="l01225"></a>01225         MSG_WAR(0x3AB1, <span class="stringliteral">&quot;SD0. Received SDO abort. No line found. Code : &quot;</span>, abortCode);
<a name="l01226"></a>01226     }
<a name="l01227"></a>01227     <span class="keywordflow">break</span>;
<a name="l01228"></a>01228   <span class="keywordflow">default</span>:
<a name="l01229"></a>01229     <span class="comment">/* Error : Unknown cs */</span>
<a name="l01230"></a>01230     MSG_ERR(0x1AB2, <span class="stringliteral">&quot;SDO. Received unknown command specifier : &quot;</span>, <a class="code" href="sdo_8c.html#ace5a1634ff4089db3b228cdd5010c321">getSDOcs</a>(m-&gt;<a class="code" href="structMessage.html#a229865b09691e658677ba76f2d82ce89">data</a>[0]));
<a name="l01231"></a>01231     <span class="keywordflow">return</span> 0xFF;
<a name="l01232"></a>01232 
<a name="l01233"></a>01233   } <span class="comment">/* End switch */</span>
<a name="l01234"></a>01234   <span class="keywordflow">return</span> 0;
<a name="l01235"></a>01235 }
<a name="l01236"></a>01236 
<a name="l01252"></a><a class="code" href="sdo_8c.html#a1a6276b79084a0905c07acc5fcfc5dc9">01252</a> INLINE UNS8 <a class="code" href="sdo_8c.html#a1a6276b79084a0905c07acc5fcfc5dc9">_writeNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS16 index,
<a name="l01253"></a>01253                        UNS8 subIndex, UNS32 count, UNS8 dataType, <span class="keywordtype">void</span> *data, SDOCallback_t Callback, UNS8 endianize)
<a name="l01254"></a>01254 {
<a name="l01255"></a>01255   UNS8 err;
<a name="l01256"></a>01256   UNS8 SDOfound = 0;
<a name="l01257"></a>01257   UNS8 line;
<a name="l01258"></a>01258   s_SDO sdo;    <span class="comment">/* SDO to transmit */</span>
<a name="l01259"></a>01259   UNS8 i;
<a name="l01260"></a>01260   UNS32 j;
<a name="l01261"></a>01261   UNS16     lastIndex;
<a name="l01262"></a>01262   UNS16     offset;
<a name="l01263"></a>01263   UNS8      *pNodeIdServer;
<a name="l01264"></a>01264   UNS8      nodeIdServer;
<a name="l01265"></a>01265 
<a name="l01266"></a>01266   MSG_WAR(0x3AC0, <span class="stringliteral">&quot;Send SDO to write in the dictionary of node : &quot;</span>, nodeId);
<a name="l01267"></a>01267   MSG_WAR(0x3AC1, <span class="stringliteral">&quot;                                   At index : &quot;</span>, index);
<a name="l01268"></a>01268   MSG_WAR(0x3AC2, <span class="stringliteral">&quot;                                   subIndex : &quot;</span>, subIndex);
<a name="l01269"></a>01269   MSG_WAR(0x3AC3, <span class="stringliteral">&quot;                                   nb bytes : &quot;</span>, count);
<a name="l01270"></a>01270 
<a name="l01271"></a>01271   <span class="comment">/* Verify that there is no SDO communication yet. */</span>
<a name="l01272"></a>01272   err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>(d, nodeId, SDO_CLIENT, &amp;line);
<a name="l01273"></a>01273   <span class="keywordflow">if</span> (!err) {
<a name="l01274"></a>01274     MSG_ERR(0x1AC4, <span class="stringliteral">&quot;SDO error : Communication yet established. with node : &quot;</span>, nodeId);
<a name="l01275"></a>01275     <span class="keywordflow">return</span> 0xFF;
<a name="l01276"></a>01276   }
<a name="l01277"></a>01277   <span class="comment">/* Taking the line ... */</span>
<a name="l01278"></a>01278   err = <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252" title="Search for an unused line in the transfers array to store a new SDO. ie a line which value of the fie...">getSDOfreeLine</a>( d, SDO_CLIENT, &amp;line );
<a name="l01279"></a>01279   <span class="keywordflow">if</span> (err) {
<a name="l01280"></a>01280     MSG_ERR(0x1AC5, <span class="stringliteral">&quot;SDO error : No line free, too many SDO in progress. Aborted for node : &quot;</span>, nodeId);
<a name="l01281"></a>01281     <span class="keywordflow">return</span> (0xFF);
<a name="l01282"></a>01282   }
<a name="l01283"></a>01283   <span class="comment">/* Check which SDO to use to communicate with the node */</span>
<a name="l01284"></a>01284   offset = d-&gt;firstIndex-&gt;SDO_CLT;
<a name="l01285"></a>01285   lastIndex = d-&gt;lastIndex-&gt;SDO_CLT;
<a name="l01286"></a>01286   <span class="keywordflow">if</span> (offset == 0) {
<a name="l01287"></a>01287     MSG_ERR(0x1AC6, <span class="stringliteral">&quot;writeNetworkDict : No SDO client index found&quot;</span>, 0);
<a name="l01288"></a>01288     <span class="keywordflow">return</span> 0xFF;
<a name="l01289"></a>01289   }
<a name="l01290"></a>01290   i = 0;
<a name="l01291"></a>01291    <span class="keywordflow">while</span> (offset &lt;= lastIndex) {
<a name="l01292"></a>01292      <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 3) {
<a name="l01293"></a>01293          MSG_ERR(0x1AC8, <span class="stringliteral">&quot;Subindex 3  not found at index &quot;</span>, 0x1280 + i);
<a name="l01294"></a>01294          <span class="keywordflow">return</span> 0xFF;
<a name="l01295"></a>01295      }
<a name="l01296"></a>01296      <span class="comment">/* looking for the nodeId server */</span>
<a name="l01297"></a>01297      pNodeIdServer = (UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject;
<a name="l01298"></a>01298      nodeIdServer = *pNodeIdServer;
<a name="l01299"></a>01299      MSG_WAR(0x1AD2, <span class="stringliteral">&quot;index : &quot;</span>, 0x1280 + i);
<a name="l01300"></a>01300      MSG_WAR(0x1AD3, <span class="stringliteral">&quot;nodeIdServer : &quot;</span>, nodeIdServer);
<a name="l01301"></a>01301 
<a name="l01302"></a>01302     <span class="keywordflow">if</span>(nodeIdServer == nodeId) {
<a name="l01303"></a>01303       SDOfound = 1;
<a name="l01304"></a>01304       <span class="keywordflow">break</span>;
<a name="l01305"></a>01305     }
<a name="l01306"></a>01306     offset++;
<a name="l01307"></a>01307     i++;
<a name="l01308"></a>01308   } <span class="comment">/* end while */</span>
<a name="l01309"></a>01309   <span class="keywordflow">if</span> (!SDOfound) {
<a name="l01310"></a>01310     MSG_ERR(0x1AC9, <span class="stringliteral">&quot;SDO. Error. No client found to communicate with node : &quot;</span>, nodeId);
<a name="l01311"></a>01311     <span class="keywordflow">return</span> 0xFE;
<a name="l01312"></a>01312   }
<a name="l01313"></a>01313   MSG_WAR(0x3AD0,<span class="stringliteral">&quot;        SDO client defined at index  : &quot;</span>, 0x1280 + i);
<a name="l01314"></a>01314   <a class="code" href="sdo_8c.html#ab9c873a15f55b29112b5527a6cc6898d" title="Initialize some fields of the structure.">initSDOline</a>(d, line, nodeId, index, subIndex, SDO_DOWNLOAD_IN_PROGRESS);
<a name="l01315"></a>01315   d-&gt;transfers[line].count = count;
<a name="l01316"></a>01316   d-&gt;transfers[line].dataType = dataType;
<a name="l01317"></a>01317 
<a name="l01318"></a>01318   <span class="comment">/* Copy data to transfers structure. */</span>
<a name="l01319"></a>01319   <span class="keywordflow">for</span> (j = 0 ; j &lt; count ; j++) {
<a name="l01320"></a>01320 <span class="preprocessor"># ifdef CANOPEN_BIG_ENDIAN</span>
<a name="l01321"></a>01321 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dataType == 0 &amp;&amp; endianize)
<a name="l01322"></a>01322       d-&gt;transfers[line].data[count - 1 - j] = ((<span class="keywordtype">char</span> *)data)[j];
<a name="l01323"></a>01323     <span class="keywordflow">else</span> <span class="comment">/* String of bytes. */</span>
<a name="l01324"></a>01324       d-&gt;transfers[line].data[j] = ((<span class="keywordtype">char</span> *)data)[j];
<a name="l01325"></a>01325 <span class="preprocessor">#  else</span>
<a name="l01326"></a>01326 <span class="preprocessor"></span>    d-&gt;transfers[line].data[j] = ((<span class="keywordtype">char</span> *)data)[j];
<a name="l01327"></a>01327 <span class="preprocessor">#  endif</span>
<a name="l01328"></a>01328 <span class="preprocessor"></span>  }
<a name="l01329"></a>01329   <span class="comment">/* Send the SDO to the server. Initiate download, cs=1. */</span>
<a name="l01330"></a>01330   sdo.nodeId = nodeId;
<a name="l01331"></a>01331   <span class="keywordflow">if</span> (count &lt;= 4) { <span class="comment">/* Expedited transfert */</span>
<a name="l01332"></a>01332     sdo.body.data[0] = (UNS8)((1 &lt;&lt; 5) | ((4 - count) &lt;&lt; 2) | 3);
<a name="l01333"></a>01333     <span class="keywordflow">for</span> (i = 4 ; i &lt; 8 ; i++)
<a name="l01334"></a>01334       sdo.body.data[i] = d-&gt;transfers[line].data[i - 4];
<a name="l01335"></a>01335     d-&gt;transfers[line].offset = count;
<a name="l01336"></a>01336   }
<a name="l01337"></a>01337   <span class="keywordflow">else</span> { 
<a name="l01338"></a>01338     sdo.body.data[0] = (1 &lt;&lt; 5) | 1;
<a name="l01339"></a>01339     <span class="keywordflow">for</span> (i = 0 ; i &lt; 4 ; i++)
<a name="l01340"></a>01340       sdo.body.data[i+4] = (UNS8)((count &lt;&lt; (i&lt;&lt;3))); <span class="comment">/* i*8 */</span>
<a name="l01341"></a>01341   }
<a name="l01342"></a>01342   sdo.body.data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span>
<a name="l01343"></a>01343   sdo.body.data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span>
<a name="l01344"></a>01344   sdo.body.data[3] = subIndex;
<a name="l01345"></a>01345 
<a name="l01346"></a>01346   d-&gt;transfers[line].Callback = Callback;
<a name="l01347"></a>01347 
<a name="l01348"></a>01348   err = <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, SDO_CLIENT, sdo);
<a name="l01349"></a>01349   <span class="keywordflow">if</span> (err) {
<a name="l01350"></a>01350     MSG_ERR(0x1AD1, <span class="stringliteral">&quot;SDO. Error while sending SDO to node : &quot;</span>, nodeId);
<a name="l01351"></a>01351     <span class="comment">/* release the line */</span>
<a name="l01352"></a>01352     <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>(d, line);
<a name="l01353"></a>01353     <span class="keywordflow">return</span> 0xFF;
<a name="l01354"></a>01354   }
<a name="l01355"></a>01355 
<a name="l01356"></a>01356 
<a name="l01357"></a>01357   <span class="keywordflow">return</span> 0;
<a name="l01358"></a>01358 }
<a name="l01359"></a>01359 
<a name="l01373"></a><a class="code" href="group__sdo.html#ga5b1848530ec78cf9c297747df09e1c47">01373</a> UNS8 <a class="code" href="group__sdo.html#ga5b1848530ec78cf9c297747df09e1c47" title="Used to send a SDO request frame to write the data at the index and subIndex indicated.">writeNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS16 index,
<a name="l01374"></a>01374                        UNS8 subIndex, UNS32 count, UNS8 dataType, <span class="keywordtype">void</span> *data)
<a name="l01375"></a>01375 {
<a name="l01376"></a>01376         <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#a1a6276b79084a0905c07acc5fcfc5dc9">_writeNetworkDict</a> (d, nodeId, index, subIndex, count, dataType, data, NULL, 1);
<a name="l01377"></a>01377 }
<a name="l01378"></a>01378 
<a name="l01393"></a><a class="code" href="group__sdo.html#ga4213ba5834ca7aa62c425e557d80e04f">01393</a> UNS8 <a class="code" href="group__sdo.html#ga4213ba5834ca7aa62c425e557d80e04f" title="Used to send a SDO request frame to write in a distant node dictionnary.">writeNetworkDictCallBack</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS16 index,
<a name="l01394"></a>01394                        UNS8 subIndex, UNS32 count, UNS8 dataType, <span class="keywordtype">void</span> *data, SDOCallback_t Callback)
<a name="l01395"></a>01395 {
<a name="l01396"></a>01396         <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#a1a6276b79084a0905c07acc5fcfc5dc9">_writeNetworkDict</a> (d, nodeId, index, subIndex, count, dataType, data, Callback, 1);
<a name="l01397"></a>01397 }
<a name="l01398"></a>01398 
<a name="l01399"></a><a class="code" href="group__sdo.html#ga3588b1278534b75148c31ed473406c77">01399</a> UNS8 <a class="code" href="group__sdo.html#ga3588b1278534b75148c31ed473406c77" title="Used to send a SDO request frame to write in a distant node dictionnary.">writeNetworkDictCallBackAI</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS16 index,
<a name="l01400"></a>01400                        UNS8 subIndex, UNS32 count, UNS8 dataType, <span class="keywordtype">void</span> *data, SDOCallback_t Callback, UNS8 endianize)
<a name="l01401"></a>01401 {
<a name="l01402"></a>01402         UNS8 ret;
<a name="l01403"></a>01403         UNS16 lastIndex;
<a name="l01404"></a>01404         UNS16 offset;
<a name="l01405"></a>01405         UNS8 nodeIdServer;
<a name="l01406"></a>01406         UNS8 i;
<a name="l01407"></a>01407 
<a name="l01408"></a>01408         ret = <a class="code" href="sdo_8c.html#a1a6276b79084a0905c07acc5fcfc5dc9">_writeNetworkDict</a> (d, nodeId, index, subIndex, count, dataType, data, Callback, endianize);
<a name="l01409"></a>01409         <span class="keywordflow">if</span>(ret == 0xFE)
<a name="l01410"></a>01410         {
<a name="l01411"></a>01411                 offset = d-&gt;firstIndex-&gt;SDO_CLT;
<a name="l01412"></a>01412                 lastIndex = d-&gt;lastIndex-&gt;SDO_CLT;
<a name="l01413"></a>01413                 <span class="keywordflow">if</span> (offset == 0)
<a name="l01414"></a>01414                 {
<a name="l01415"></a>01415                         MSG_ERR(0x1AC6, <span class="stringliteral">&quot;writeNetworkDict : No SDO client index found&quot;</span>, 0);
<a name="l01416"></a>01416                         <span class="keywordflow">return</span> 0xFF;
<a name="l01417"></a>01417                 }
<a name="l01418"></a>01418                 i = 0;
<a name="l01419"></a>01419                 <span class="keywordflow">while</span> (offset &lt;= lastIndex)
<a name="l01420"></a>01420                 {
<a name="l01421"></a>01421                         <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 3)
<a name="l01422"></a>01422                     {
<a name="l01423"></a>01423                         MSG_ERR(0x1AC8, <span class="stringliteral">&quot;Subindex 3  not found at index &quot;</span>, 0x1280 + i);
<a name="l01424"></a>01424                         <span class="keywordflow">return</span> 0xFF;
<a name="l01425"></a>01425                     }
<a name="l01426"></a>01426                         nodeIdServer = *(UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject;
<a name="l01427"></a>01427                         <span class="keywordflow">if</span>(nodeIdServer == 0)
<a name="l01428"></a>01428                         {
<a name="l01429"></a>01429                                 *(UNS32*)d-&gt;objdict[offset].pSubindex[1].pObject = (UNS32)(0x600 + nodeId);
<a name="l01430"></a>01430                                 *(UNS32*)d-&gt;objdict[offset].pSubindex[2].pObject = (UNS32)(0x580 + nodeId);
<a name="l01431"></a>01431                                 *(UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject = nodeId;
<a name="l01432"></a>01432                                 <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#a1a6276b79084a0905c07acc5fcfc5dc9">_writeNetworkDict</a> (d, nodeId, index, subIndex, count, dataType, data, Callback, 1);
<a name="l01433"></a>01433                         }
<a name="l01434"></a>01434                         offset++;
<a name="l01435"></a>01435                 }
<a name="l01436"></a>01436                 <span class="keywordflow">return</span> 0xFF;
<a name="l01437"></a>01437         }
<a name="l01438"></a>01438         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ret == 0)
<a name="l01439"></a>01439         {
<a name="l01440"></a>01440                 <span class="keywordflow">return</span> 0;
<a name="l01441"></a>01441         }
<a name="l01442"></a>01442         <span class="keywordflow">else</span>
<a name="l01443"></a>01443         {
<a name="l01444"></a>01444                 <span class="keywordflow">return</span> 0xFF;
<a name="l01445"></a>01445         }
<a name="l01446"></a>01446 }
<a name="l01447"></a>01447 
<a name="l01460"></a><a class="code" href="sdo_8c.html#a4bb4b3cd35af7e7580cffde23e9d3270">01460</a> INLINE UNS8 <a class="code" href="sdo_8c.html#a4bb4b3cd35af7e7580cffde23e9d3270">_readNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, SDOCallback_t Callback)
<a name="l01461"></a>01461 {
<a name="l01462"></a>01462   UNS8 err;
<a name="l01463"></a>01463   UNS8 SDOfound = 0;
<a name="l01464"></a>01464   UNS8 i;
<a name="l01465"></a>01465   UNS8 line;
<a name="l01466"></a>01466   s_SDO sdo;    <span class="comment">/* SDO to transmit */</span>
<a name="l01467"></a>01467   UNS8      *pNodeIdServer;
<a name="l01468"></a>01468   UNS8      nodeIdServer;
<a name="l01469"></a>01469   UNS16     offset;
<a name="l01470"></a>01470   UNS16     lastIndex;
<a name="l01471"></a>01471   MSG_WAR(0x3AD5, <span class="stringliteral">&quot;Send SDO to read in the dictionary of node : &quot;</span>, nodeId);
<a name="l01472"></a>01472   MSG_WAR(0x3AD6, <span class="stringliteral">&quot;                                  At index : &quot;</span>, index);
<a name="l01473"></a>01473   MSG_WAR(0x3AD7, <span class="stringliteral">&quot;                                  subIndex : &quot;</span>, subIndex);
<a name="l01474"></a>01474 
<a name="l01475"></a>01475 
<a name="l01476"></a>01476   <span class="comment">/* Verify that there is no SDO communication yet. */</span>
<a name="l01477"></a>01477   err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>(d, nodeId, SDO_CLIENT, &amp;line);
<a name="l01478"></a>01478   <span class="keywordflow">if</span> (!err) {
<a name="l01479"></a>01479     MSG_ERR(0x1AD8, <span class="stringliteral">&quot;SDO error : Communication yet established. with node : &quot;</span>, nodeId);
<a name="l01480"></a>01480     <span class="keywordflow">return</span> 0xFF;
<a name="l01481"></a>01481   }
<a name="l01482"></a>01482   <span class="comment">/* Taking the line ... */</span>
<a name="l01483"></a>01483   err = <a class="code" href="sdo_8c.html#a58d1f9691977617601beb9e5b4123252" title="Search for an unused line in the transfers array to store a new SDO. ie a line which value of the fie...">getSDOfreeLine</a>( d, SDO_CLIENT, &amp;line );
<a name="l01484"></a>01484   <span class="keywordflow">if</span> (err) {
<a name="l01485"></a>01485     MSG_ERR(0x1AD9, <span class="stringliteral">&quot;SDO error : No line free, too many SDO in progress. Aborted for node : &quot;</span>, nodeId);
<a name="l01486"></a>01486     <span class="keywordflow">return</span> (0xFF);
<a name="l01487"></a>01487   }
<a name="l01488"></a>01488   <span class="keywordflow">else</span>
<a name="l01489"></a>01489     MSG_WAR(0x3AE0, <span class="stringliteral">&quot;Transmission on line : &quot;</span>, line);
<a name="l01490"></a>01490 
<a name="l01491"></a>01491   <span class="comment">/* Check which SDO to use to communicate with the node */</span>
<a name="l01492"></a>01492   offset = d-&gt;firstIndex-&gt;SDO_CLT;
<a name="l01493"></a>01493   lastIndex = d-&gt;lastIndex-&gt;SDO_CLT;
<a name="l01494"></a>01494   <span class="keywordflow">if</span> (offset == 0) {
<a name="l01495"></a>01495     MSG_ERR(0x1AE1, <span class="stringliteral">&quot;writeNetworkDict : No SDO client index found&quot;</span>, 0);
<a name="l01496"></a>01496     <span class="keywordflow">return</span> 0xFF;
<a name="l01497"></a>01497   }
<a name="l01498"></a>01498   i = 0;
<a name="l01499"></a>01499   <span class="keywordflow">while</span> (offset &lt;= lastIndex) {
<a name="l01500"></a>01500      <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 3) {
<a name="l01501"></a>01501          MSG_ERR(0x1AE2, <span class="stringliteral">&quot;Subindex 3  not found at index &quot;</span>, 0x1280 + i);
<a name="l01502"></a>01502          <span class="keywordflow">return</span> 0xFF;
<a name="l01503"></a>01503      }
<a name="l01504"></a>01504      <span class="comment">/* looking for the nodeId server */</span>
<a name="l01505"></a>01505      pNodeIdServer = (UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject;
<a name="l01506"></a>01506      nodeIdServer = *pNodeIdServer;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508     <span class="keywordflow">if</span>(nodeIdServer == nodeId) {
<a name="l01509"></a>01509       SDOfound = 1;
<a name="l01510"></a>01510       <span class="keywordflow">break</span>;
<a name="l01511"></a>01511     }
<a name="l01512"></a>01512     offset++;
<a name="l01513"></a>01513     i++;
<a name="l01514"></a>01514   } <span class="comment">/* end while */</span>
<a name="l01515"></a>01515   <span class="keywordflow">if</span> (!SDOfound) {
<a name="l01516"></a>01516     MSG_ERR(0x1AE3, <span class="stringliteral">&quot;SDO. Error. No client found to communicate with node : &quot;</span>, nodeId);
<a name="l01517"></a>01517     <span class="keywordflow">return</span> 0xFE;
<a name="l01518"></a>01518   }
<a name="l01519"></a>01519   MSG_WAR(0x3AE4,<span class="stringliteral">&quot;        SDO client defined at index  : &quot;</span>, 0x1280 + i);
<a name="l01520"></a>01520   <a class="code" href="sdo_8c.html#ab9c873a15f55b29112b5527a6cc6898d" title="Initialize some fields of the structure.">initSDOline</a>(d, line, nodeId, index, subIndex, SDO_UPLOAD_IN_PROGRESS);
<a name="l01521"></a>01521   <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>(d, nodeId, SDO_CLIENT, &amp;line);
<a name="l01522"></a>01522   sdo.nodeId = nodeId;
<a name="l01523"></a>01523   <span class="comment">/* Send the SDO to the server. Initiate upload, cs=2. */</span>
<a name="l01524"></a>01524   d-&gt;transfers[line].dataType = dataType;
<a name="l01525"></a>01525   sdo.body.data[0] = (2 &lt;&lt; 5);
<a name="l01526"></a>01526   sdo.body.data[1] = index &amp; 0xFF;        <span class="comment">/* LSB */</span>
<a name="l01527"></a>01527   sdo.body.data[2] = (index &gt;&gt; 8) &amp; 0xFF; <span class="comment">/* MSB */</span>
<a name="l01528"></a>01528   sdo.body.data[3] = subIndex;
<a name="l01529"></a>01529   <span class="keywordflow">for</span> (i = 4 ; i &lt; 8 ; i++)
<a name="l01530"></a>01530     sdo.body.data[i] = 0;
<a name="l01531"></a>01531   d-&gt;transfers[line].Callback = Callback;
<a name="l01532"></a>01532   err = <a class="code" href="sdo_8c.html#ac6b5d7d1439d537da992a96644a1ca5d" title="Transmit a SDO frame on the bus bus_id.">sendSDO</a>(d, SDO_CLIENT, sdo);
<a name="l01533"></a>01533   <span class="keywordflow">if</span> (err) {
<a name="l01534"></a>01534     MSG_ERR(0x1AE5, <span class="stringliteral">&quot;SDO. Error while sending SDO to node : &quot;</span>, nodeId);
<a name="l01535"></a>01535     <span class="comment">/* release the line */</span>
<a name="l01536"></a>01536     <a class="code" href="sdo_8c.html#a42d33be015d4c4c83c73f1f0e588f481" title="Reset an unused line.">resetSDOline</a>(d, line);
<a name="l01537"></a>01537     <span class="keywordflow">return</span> 0xFF;
<a name="l01538"></a>01538   }
<a name="l01539"></a>01539   <span class="keywordflow">return</span> 0;
<a name="l01540"></a>01540 }
<a name="l01541"></a>01541 
<a name="l01553"></a><a class="code" href="group__sdo.html#ga0e102a0835e4115920cd406e80a8d135">01553</a> UNS8 <a class="code" href="group__sdo.html#ga0e102a0835e4115920cd406e80a8d135" title="Used to send a SDO request frame to read.">readNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType)
<a name="l01554"></a>01554 {
<a name="l01555"></a>01555         <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#a4bb4b3cd35af7e7580cffde23e9d3270">_readNetworkDict</a> (d, nodeId, index, subIndex, dataType, NULL);
<a name="l01556"></a>01556 }
<a name="l01557"></a>01557 
<a name="l01570"></a><a class="code" href="group__sdo.html#ga542a5cdd20c00aa130a39fe68295e769">01570</a> UNS8 <a class="code" href="group__sdo.html#ga542a5cdd20c00aa130a39fe68295e769" title="Used to send a SDO request frame to read in a distant node dictionnary.">readNetworkDictCallback</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, SDOCallback_t Callback)
<a name="l01571"></a>01571 {
<a name="l01572"></a>01572         <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#a4bb4b3cd35af7e7580cffde23e9d3270">_readNetworkDict</a> (d, nodeId, index, subIndex, dataType, Callback);
<a name="l01573"></a>01573 }
<a name="l01574"></a>01574 
<a name="l01575"></a><a class="code" href="group__sdo.html#ga5fe9abeafde31c9c8bf7d468c1dcb6c9">01575</a> UNS8 <a class="code" href="group__sdo.html#ga5fe9abeafde31c9c8bf7d468c1dcb6c9" title="Used to send a SDO request frame to read in a distant node dictionnary.">readNetworkDictCallbackAI</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS16 index, UNS8 subIndex, UNS8 dataType, SDOCallback_t Callback)
<a name="l01576"></a>01576 {
<a name="l01577"></a>01577         UNS8 ret;
<a name="l01578"></a>01578         UNS16 lastIndex;
<a name="l01579"></a>01579         UNS16 offset;
<a name="l01580"></a>01580         UNS8 nodeIdServer;
<a name="l01581"></a>01581         UNS8 i;
<a name="l01582"></a>01582 
<a name="l01583"></a>01583         ret = <a class="code" href="sdo_8c.html#a4bb4b3cd35af7e7580cffde23e9d3270">_readNetworkDict</a> (d, nodeId, index, subIndex, dataType, Callback);
<a name="l01584"></a>01584         <span class="keywordflow">if</span>(ret == 0xFE)
<a name="l01585"></a>01585         {
<a name="l01586"></a>01586                 offset = d-&gt;firstIndex-&gt;SDO_CLT;
<a name="l01587"></a>01587                 lastIndex = d-&gt;lastIndex-&gt;SDO_CLT;
<a name="l01588"></a>01588                 <span class="keywordflow">if</span> (offset == 0)
<a name="l01589"></a>01589                 {
<a name="l01590"></a>01590                         MSG_ERR(0x1AC6, <span class="stringliteral">&quot;writeNetworkDict : No SDO client index found&quot;</span>, 0);
<a name="l01591"></a>01591                         <span class="keywordflow">return</span> 0xFF;
<a name="l01592"></a>01592                 }
<a name="l01593"></a>01593                 i = 0;
<a name="l01594"></a>01594                 <span class="keywordflow">while</span> (offset &lt;= lastIndex)
<a name="l01595"></a>01595                 {
<a name="l01596"></a>01596                         <span class="keywordflow">if</span> (d-&gt;objdict[offset].bSubCount &lt;= 3)
<a name="l01597"></a>01597                     {
<a name="l01598"></a>01598                         MSG_ERR(0x1AC8, <span class="stringliteral">&quot;Subindex 3  not found at index &quot;</span>, 0x1280 + i);
<a name="l01599"></a>01599                         <span class="keywordflow">return</span> 0xFF;
<a name="l01600"></a>01600                     }
<a name="l01601"></a>01601                         nodeIdServer = *(UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject;
<a name="l01602"></a>01602                         <span class="keywordflow">if</span>(nodeIdServer == 0)
<a name="l01603"></a>01603                         {
<a name="l01604"></a>01604                                 *(UNS32*)d-&gt;objdict[offset].pSubindex[1].pObject = (UNS32)(0x600 + nodeId);
<a name="l01605"></a>01605                                 *(UNS32*)d-&gt;objdict[offset].pSubindex[2].pObject = (UNS32)(0x580 + nodeId);
<a name="l01606"></a>01606                                 *(UNS8*) d-&gt;objdict[offset].pSubindex[3].pObject = nodeId;
<a name="l01607"></a>01607                                 <span class="keywordflow">return</span> <a class="code" href="sdo_8c.html#a4bb4b3cd35af7e7580cffde23e9d3270">_readNetworkDict</a> (d, nodeId, index, subIndex, dataType, Callback);
<a name="l01608"></a>01608                         }
<a name="l01609"></a>01609                         offset++;
<a name="l01610"></a>01610                 }
<a name="l01611"></a>01611                 <span class="keywordflow">return</span> 0xFF;
<a name="l01612"></a>01612         }
<a name="l01613"></a>01613         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ret == 0)
<a name="l01614"></a>01614         {
<a name="l01615"></a>01615                 <span class="keywordflow">return</span> 0;
<a name="l01616"></a>01616         }
<a name="l01617"></a>01617         <span class="keywordflow">else</span>
<a name="l01618"></a>01618         {
<a name="l01619"></a>01619                 <span class="keywordflow">return</span> 0xFF;
<a name="l01620"></a>01620         }
<a name="l01621"></a>01621 }
<a name="l01622"></a>01622 
<a name="l01634"></a><a class="code" href="group__sdo.html#gab8a362443447b15446e516130ececfe4">01634</a> UNS8 <a class="code" href="group__sdo.html#gab8a362443447b15446e516130ececfe4" title="Use this function after calling readNetworkDict to get the result.">getReadResultNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, <span class="keywordtype">void</span>* data, UNS32 *size,
<a name="l01635"></a>01635                                UNS32 * abortCode)
<a name="l01636"></a>01636 {
<a name="l01637"></a>01637   UNS32 i;
<a name="l01638"></a>01638   UNS8 err;
<a name="l01639"></a>01639   UNS8 line;
<a name="l01640"></a>01640   * abortCode = 0;
<a name="l01641"></a>01641 
<a name="l01642"></a>01642   <span class="comment">/* Looking for the line tranfert. */</span>
<a name="l01643"></a>01643   err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>(d, nodeId, SDO_CLIENT, &amp;line);
<a name="l01644"></a>01644   <span class="keywordflow">if</span> (err) {
<a name="l01645"></a>01645     MSG_ERR(0x1AF0, <span class="stringliteral">&quot;SDO error : No line found for communication with node : &quot;</span>, nodeId);
<a name="l01646"></a>01646     <span class="keywordflow">return</span> SDO_ABORTED_INTERNAL;
<a name="l01647"></a>01647   }
<a name="l01648"></a>01648   * abortCode = d-&gt;transfers[line].abortCode;
<a name="l01649"></a>01649   <span class="keywordflow">if</span> (d-&gt;transfers[line].state != SDO_FINISHED)
<a name="l01650"></a>01650     <span class="keywordflow">return</span> d-&gt;transfers[line].state;
<a name="l01651"></a>01651 
<a name="l01652"></a>01652   <span class="comment">/* if SDO initiated with e=0 and s=0 count is null, offset carry effective size*/</span>
<a name="l01653"></a>01653   <span class="keywordflow">if</span>( d-&gt;transfers[line].count == 0)
<a name="l01654"></a>01654         d-&gt;transfers[line].count = d-&gt;transfers[line].offset;
<a name="l01655"></a>01655   <span class="comment">/* use transfers[line].count as max size */</span>
<a name="l01656"></a>01656   <span class="keywordflow">if</span>( d-&gt;transfers[line].count &lt; *size )
<a name="l01657"></a>01657         *size = d-&gt;transfers[line].count;
<a name="l01658"></a>01658   <span class="comment">/* Copy payload to data pointer */</span>
<a name="l01659"></a>01659   <span class="keywordflow">for</span>  ( i = 0 ; i &lt; *size ; i++) {
<a name="l01660"></a>01660 <span class="preprocessor"># ifdef CANOPEN_BIG_ENDIAN</span>
<a name="l01661"></a>01661 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (d-&gt;transfers[line].dataType != visible_string)
<a name="l01662"></a>01662       ( (<span class="keywordtype">char</span> *) data)[*size - 1 - i] = d-&gt;transfers[line].data[i];
<a name="l01663"></a>01663     <span class="keywordflow">else</span> <span class="comment">/* String of bytes. */</span>
<a name="l01664"></a>01664       ( (<span class="keywordtype">char</span> *) data)[i] = d-&gt;transfers[line].data[i];
<a name="l01665"></a>01665 <span class="preprocessor"># else</span>
<a name="l01666"></a>01666 <span class="preprocessor"></span>    ( (<span class="keywordtype">char</span> *) data)[i] = d-&gt;transfers[line].data[i];
<a name="l01667"></a>01667 <span class="preprocessor"># endif</span>
<a name="l01668"></a>01668 <span class="preprocessor"></span>  }
<a name="l01669"></a>01669   <span class="keywordflow">return</span> SDO_FINISHED;
<a name="l01670"></a>01670 }
<a name="l01671"></a>01671 
<a name="l01681"></a><a class="code" href="group__sdo.html#ga8671e306873f19362c60bb50ab930d1d">01681</a> UNS8 <a class="code" href="group__sdo.html#ga8671e306873f19362c60bb50ab930d1d" title="Use this function after calling writeNetworkDict function to get the result of the write...">getWriteResultNetworkDict</a> (<a class="code" href="structstruct__CO__Data.html" title="This structure contains all necessary informations to define a CANOpen node.">CO_Data</a>* d, UNS8 nodeId, UNS32 * abortCode)
<a name="l01682"></a>01682 {
<a name="l01683"></a>01683   UNS8 line = 0;
<a name="l01684"></a>01684   UNS8 err;
<a name="l01685"></a>01685 
<a name="l01686"></a>01686   * abortCode = 0;
<a name="l01687"></a>01687   <span class="comment">/* Looking for the line tranfert. */</span>
<a name="l01688"></a>01688   err = <a class="code" href="sdo_8c.html#abb0c376b048ab2c6e0524b135b62376f" title="Search for the line, in the transfers array, which contains the beginning of the reception of a fragm...">getSDOlineOnUse</a>(d, nodeId, SDO_CLIENT, &amp;line);
<a name="l01689"></a>01689   <span class="keywordflow">if</span> (err) {
<a name="l01690"></a>01690     MSG_ERR(0x1AF1, <span class="stringliteral">&quot;SDO error : No line found for communication with node : &quot;</span>, nodeId);
<a name="l01691"></a>01691     <span class="keywordflow">return</span> SDO_ABORTED_INTERNAL;
<a name="l01692"></a>01692   }
<a name="l01693"></a>01693   * abortCode = d-&gt;transfers[line].abortCode;
<a name="l01694"></a>01694   <span class="keywordflow">return</span> d-&gt;transfers[line].state;
<a name="l01695"></a>01695 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Sat Feb 5 2011 14:13:00 for CanFestival by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
